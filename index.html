<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>関東学生バドミントン連盟 登録管理システム</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* 基本スタイル */
        body {
            font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
        }

        .menu-list .list-group-item {
            cursor: pointer;
            border-left: 4px solid transparent;
            transition: all 0.2s;
        }

        .menu-list .list-group-item:hover {
            background-color: #f8f9fa;
        }

        .menu-list .list-group-item.active {
            background-color: #e7f1ff;
            color: #0d6efd;
            border-left-color: #0d6efd;
            border-color: #dee2e6;
            font-weight: bold;
        }

        .main-content-card {
            min-height: 500px;
            border-top: 4px solid #0d6efd;
        }

        .auth-tab {
            cursor: pointer;
            padding: 10px;
            border-bottom: 2px solid transparent;
            width: 50%;
            text-align: center;
        }

        .auth-tab.active {
            border-bottom: 3px solid #0d6efd;
            color: #0d6efd;
            font-weight: bold;
            background-color: #f8f9fa;
        }

        .univ-list-container {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
        }

        .univ-list-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }

        .univ-list-item:hover {
            background-color: #e9ecef;
        }

        .univ-list-item.selected {
            background-color: #cfe2ff;
            color: #084298;
            font-weight: bold;
        }

        .payment-box {
            background-color: #fff3cd;
            border: 1px solid #ffecb5;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }

        .payment-id {
            font-family: monospace;
            font-size: 1.4rem;
            font-weight: bold;
            letter-spacing: 2px;
            background: white;
            padding: 2px 10px;
            border-radius: 4px;
            border: 2px solid #ffc107;
            display: inline-block;
            color: #000;
        }

        .receipt-preview {
            max-width: 100%;
            max-height: 200px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 10px;
        }

        .receipt-area {
            background-color: #fff;
            border: 2px dashed #bbb;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: center;
        }

        .save-area {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #dee2e6;
            text-align: center;
        }

        .excel-upload-area {
            background-color: #f1f8ff;
            border: 2px dashed #0d6efd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
        }

        .count-input-group {
            background: #fff;
            padding: 15px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
        }

        .badge-uploaded {
            background-color: #198754;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .badge-missing {
            background-color: #dc3545;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .report-container {
            background-color: white;
            padding: 40px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            border: 2px solid #000;
            table-layout: fixed;
        }

        .report-table th,
        .report-table td {
            border: 1px solid #000;
            padding: 10px 15px;
            vertical-align: middle;
            word-wrap: break-word;
        }

        .report-table th {
            background-color: #f2f2f2;
            text-align: center;
            font-weight: bold;
            border-bottom: 2px solid #000;
        }

        .report-table tfoot th,
        .report-table tfoot td {
            border-top: 2px solid #000;
            background-color: #f9f9f9;
            font-weight: bold;
        }

        .report-table .col-item {
            width: 25%;
        }

        .report-table .col-detail {
            width: 55%;
            font-size: 0.9rem;
        }

        .report-table .col-price {
            width: 20%;
            text-align: right;
        }

        .memo-box {
            border: 1px solid #000;
            padding: 15px;
            min-height: 150px;
            border-radius: 4px;
            white-space: pre-wrap;
            background: #fff;
        }

        .status-badge {
            font-size: 0.8rem;
            cursor: pointer;
            display: inline-block;
            width: 100%;
            text-align: center;
            padding: 4px 0;
            border-radius: 4px;
            border: 1px solid #ddd;
            margin-bottom: 2px;
        }

        .status-none {
            background-color: #f8f9fa;
            color: #aaa;
        }

        .status-waiting {
            background-color: #fff3cd;
            color: #856404;
            border-color: #ffeeba;
        }

        .status-done {
            background-color: #d1e7dd;
            color: #0f5132;
            border-color: #badbcc;
            font-weight: bold;
        }

        .status-pending {
            background-color: #fd7e14;
            color: white;
            border-color: #e87311;
        }

        .status-payout-done {
            background-color: #cff4fc;
            color: #055160;
            border-color: #b6effb;
            font-weight: bold;
        }

        .btn-approve {
            font-weight: bold;
            padding: 10px 30px;
            font-size: 1.1rem;
        }

        .receipt-modal-img {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
        }

        .table-admin th {
            background-color: #343a40;
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 0.85rem;
            white-space: nowrap;
        }

        .table-admin td {
            vertical-align: middle;
            font-size: 0.9rem;
        }

        .univ-name-cell {
            min-width: 150px;
            font-weight: bold;
        }

        .money-cell {
            font-family: monospace;
            text-align: right;
            white-space: nowrap;
        }

        .password-cell {
            font-family: monospace;
            color: #d63384;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .add-reg-card {
            border-left: 5px solid #198754;
            transition: all 0.3s;
        }

        .add-reg-card:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .add-reg-index {
            position: absolute;
            top: -10px;
            left: -10px;
            width: 30px;
            height: 30px;
            background: #198754;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            font-weight: bold;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
        }

        .claim-card {
            border-left: 5px solid #0dcaf0;
        }

        .fixed-alert {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            min-width: 250px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .fade-enter-active,
        .fade-leave-active {
            transition: opacity 0.5s ease;
        }

        .fade-enter-from,
        .fade-leave-to {
            opacity: 0;
        }

        @media print {
            body {
                background-color: white;
                color: black;
            }

            .no-print,
            .menu-list,
            .btn,
            .card-header,
            .save-area,
            nav,
            .payment-box button,
            .excel-upload-area,
            .count-input-group,
            .fixed-alert,
            .embedded-chat {
                display: none !important;
            }

            .container-fluid,
            .row,
            .col-md-9,
            .col-lg-10 {
                padding: 0 !important;
                margin: 0 !important;
                width: 100% !important;
                max-width: 100% !important;
                flex: none !important;
            }

            .main-content-card {
                border: none !important;
                box-shadow: none !important;
                min-height: 0 !important;
            }

            .card-body {
                padding: 0 !important;
            }

            .report-container {
                border: none;
                box-shadow: none;
                padding: 0;
            }

            .report-table th {
                background-color: #f0f0f0 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .page-break {
                page-break-before: always;
            }

            body>* {
                display: none !important;
            }

            #receiptModal {
                display: block !important;
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                z-index: 9999;
            }

            #receiptModal .modal-dialog {
                margin: 0;
                max-width: 100%;
            }

            #receiptModal .modal-content {
                border: none;
                box-shadow: none;
            }

            #receiptModal .modal-header,
            #receiptModal .modal-footer {
                display: none !important;
            }

            #receiptModal .modal-body {
                padding: 0;
            }

            .receipt-layout {
                border: none;
                padding: 20px;
            }
        }

        .receipt-layout {
            border: 4px double #333;
            padding: 40px;
            color: #000;
            font-family: "Mincho", serif;
            position: relative;
            background: white;
        }

        .receipt-title {
            font-size: 2rem;
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #333;
            display: inline-block;
            padding: 0 20px;
        }

        .receipt-amount {
            font-size: 2.5rem;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            border-bottom: 1px solid #000;
        }

        .receipt-detail {
            margin-top: 20px;
            font-size: 1.1rem;
            line-height: 1.8;
        }

        .issuer-info {
            margin-top: 40px;
            text-align: right;
            position: relative;
        }

        .hanko-box {
            position: absolute;
            right: 0;
            top: 0;
            width: 90px;
            height: 90px;
            opacity: 0.85;
            transform: rotate(-2deg);
            user-select: none;
        }

        @media print {
            .hanko-box {
                opacity: 1;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }

        /* チャット用スタイル */
        .embedded-chat {
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 600px;
            background: white;
        }

        .chat-body {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .chat-footer {
            padding: 10px;
            border-top: 1px solid #ddd;
            background: white;
            display: flex;
            gap: 5px;
        }

        .msg-row {
            display: flex;
            margin-bottom: 5px;
        }

        .msg-row.mine {
            justify-content: flex-end;
        }

        .msg-row.theirs {
            justify-content: flex-start;
        }

        .msg-bubble {
            max-width: 80%;
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 0.9rem;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        .mine .msg-bubble {
            background-color: #0d6efd;
            color: white;
            border-bottom-right-radius: 2px;
        }

        .theirs .msg-bubble {
            background-color: #e9ecef;
            color: black;
            border-bottom-left-radius: 2px;
        }

        .msg-time {
            font-size: 0.7rem;
            color: #aaa;
            margin-top: 2px;
            text-align: right;
        }

        .admin-chat-modal-body {
            height: 60vh;
            display: flex;
            flex-direction: column;
            padding: 0;
        }

        .badge-notify {
            position: absolute;
            top: 0;
            right: 0;
            background-color: #dc3545;
            color: white;
            font-size: 0.65rem;
            padding: 0.2em 0.5em;
            border-radius: 10rem;
            transform: translate(50%, -50%);
        }

        [v-cloak] {
            display: none !important;
        }
    </style>
</head>

<body>
    <div id="app" class="container-fluid py-3" style="max-width: 1200px;" v-cloak>
        <transition name="fade">
            <div v-if="saveMessage" class="alert alert-success fixed-alert d-flex align-items-center">
                <i class="bi bi-check-circle-fill me-2 fs-4"></i>
                <div class="fw-bold">{{ saveMessage }}</div>
            </div>
        </transition>

        <div v-if="isLoading" class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2">データを読み込んでいます...</p>
        </div>

        <div v-else>
            <div v-if="!user && !isAdmin" class="row justify-content-center mt-5">
                <div class="col-md-6 col-lg-5">
                    <div class="card shadow-sm">
                        <div class="card-header bg-white p-0">
                            <div class="d-flex">
                                <div class="auth-tab" :class="{active: !isRegisterMode}"
                                    @click="isRegisterMode = false">ログイン</div>
                                <div class="auth-tab" :class="{active: isRegisterMode}" @click="toggleRegisterMode">新規登録
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-4">
                            <h4 class="text-center mb-4">関東学生バドミントン連盟</h4>
                            <div v-if="isRegisterMode">
                                <div class="alert alert-light border small mb-3"><i class="bi bi-info-circle"></i>
                                    リストから大学を選択してください。<br>※各大学1アカウントのみ登録可能です。</div>
                                <div class="mb-3"><label class="form-label fw-bold">1. 種別</label>
                                    <div class="d-flex gap-4 p-2 border rounded bg-light">
                                        <div class="form-check"><input class="form-check-input" type="radio" value="1"
                                                v-model="regGender" @change="resetSelection" id="g1"><label
                                                class="form-check-label" for="g1">男子 (1000番台)</label></div>
                                        <div class="form-check"><input class="form-check-input" type="radio" value="2"
                                                v-model="regGender" @change="resetSelection" id="g2"><label
                                                class="form-check-label" for="g2">女子 (2000番台)</label></div>
                                    </div>
                                </div>
                                <div class="mb-4"><label class="form-label fw-bold">2. 大学選択</label><input type="text"
                                        class="form-control mb-2" v-model="searchQuery" placeholder="大学名で検索..."
                                        :disabled="!regGender">
                                    <div class="univ-list-container bg-white">
                                        <div v-if="filteredUnivList.length === 0"
                                            class="p-3 text-muted text-center small">該当なし</div>
                                        <div v-for="univ in filteredUnivList" :key="univ.univ_id"
                                            class="univ-list-item d-flex justify-content-between"
                                            :class="{ selected: regForm.univ_id === univ.univ_id }"
                                            @click="selectUniv(univ)"><span>{{ univ.univ_name }}</span><span
                                                class="badge bg-light text-dark border">{{ univ.univ_id }}</span></div>
                                    </div>
                                    <div v-if="regForm.univ_id"
                                        class="mt-2 p-2 bg-primary bg-opacity-10 border border-primary rounded text-primary text-center">
                                        選択中: <strong>{{ regUnivName }}</strong></div>
                                    <div v-if="regError" class="mt-2 text-danger small"><i
                                            class="bi bi-exclamation-triangle"></i> {{ regError }}</div>
                                </div>
                                <div class="mb-3"><label class="form-label fw-bold">氏名 (代表者名)</label><input type="text"
                                        v-model="authName" class="form-control" placeholder="例: 山田 太郎"></div>
                            </div>
                            <div class="mb-3"><label class="form-label">メールアドレス</label><input type="text"
                                    v-model="authEmail" class="form-control"></div>
                            <div class="mb-2"><label class="form-label">パスワード (6文字以上)</label><input type="password"
                                    v-model="authPass" class="form-control"></div>
                            <div v-if="!isRegisterMode" class="text-end mb-4"><a href="#"
                                    class="small text-decoration-none"
                                    @click.prevent="resetPassword">パスワードを忘れた場合はこちら</a></div>
                            <button v-if="!isRegisterMode" @click="login"
                                class="btn btn-primary w-100 py-2">ログイン</button>
                            <button v-else @click="register" class="btn btn-success w-100 py-2"
                                :disabled="!!regError || !regForm.univ_id">登録して開始</button>
                        </div>
                    </div>
                </div>
            </div>

            <div v-else-if="isAdmin">
                <nav class="navbar navbar-dark bg-dark px-3 mb-3 rounded">
                    <span class="navbar-brand mb-0 h1"><i class="bi bi-speedometer2"></i> 管理者ダッシュボード</span>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-warning fw-bold text-dark" @click="showDeadlineModal = true"><i
                                class="bi bi-calendar-event"></i> 期限設定</button>
                        <button class="btn btn-sm btn-info fw-bold text-dark" @click="downloadPlayerRegList">
                            <i class="bi bi-people-fill"></i> 選手名簿DL
                        </button>
                        <button class="btn btn-sm btn-outline-light" @click="downloadAllCSV"><i
                                class="bi bi-file-earmark-spreadsheet"></i> 全データCSV</button>
                        <button class="btn btn-sm btn-danger" @click="logout">ログアウト</button>
                    </div>
                </nav>

                <div class="card mb-4 border-primary">
                    <div class="card-header bg-primary text-white fw-bold"><i class="bi bi-folder-fill"></i> 大会データ管理
                    </div>
                    <div class="card-body">
                        <div class="row align-items-end g-2">
                            <div class="col-md-4"><label class="form-label small fw-bold">対象の大会を選択</label><select
                                    v-model="selectedTournament" class="form-select">
                                    <option v-for="(label, key) in categoryLabels" :value="key" :key="key">{{ label }}
                                    </option>
                                </select></div>
                            <div class="col-md-8">
                                <div class="d-flex gap-2">
                                    <button class="btn btn-success" @click="downloadTournamentZip"><i
                                            class="bi bi-file-earmark-zip-fill"></i> Excel一括DL (ZIP)</button>
                                    <button class="btn btn-warning text-dark fw-bold"
                                        @click="downloadAllParticipantsExcel"><i class="bi bi-person-lines-fill"></i>
                                        参加者名簿作成</button>
                                    <button class="btn btn-outline-dark" @click="downloadTournamentCSV"><i
                                            class="bi bi-file-text"></i> CSV出力</button>
                                </div>
                                <div v-if="isZipping || isGeneratingList" class="text-success small mt-1">
                                    <div class="spinner-border spinner-border-sm" role="status"></div> {{ isZipping ?
                                    'ファイルを収集中...' : '名簿を作成中...各大学のファイルを解析しています' }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4 border-info">
                    <div class="card-header bg-info text-white fw-bold"><i class="bi bi-megaphone-fill"></i> 連絡事項の管理
                    </div>
                    <div class="card-body">
                        <div class="row g-2">
                            <div class="col-md-3"><input type="date" class="form-control" v-model="adminNews.date">
                            </div>
                            <div class="col-md-9"><input type="text" class="form-control" v-model="adminNews.title"
                                    placeholder="タイトル"></div>
                            <div class="col-12"><textarea class="form-control" v-model="adminNews.content" rows="3"
                                    placeholder="本文"></textarea></div>
                            <div class="col-12">
                                <label class="form-label small fw-bold"><i class="bi bi-paperclip"></i> 添付ファイル </label>
                                <input type="file" class="form-control form-control-sm" @change="uploadNewsFile">
                                <div v-if="adminNews.url" class="mt-1 small text-success"><i
                                        class="bi bi-check-circle"></i> アップロード完了 <a :href="adminNews.url"
                                        target="_blank" class="ms-2 text-decoration-none">確認</a></div>
                                <div v-if="isUploadingNews" class="spinner-border spinner-border-sm mt-1 text-primary">
                                </div>
                            </div>
                        </div>
                        <div class="mt-2"><button class="btn btn-info text-white fw-bold" @click="addNews"
                                :disabled="isUploadingNews">投稿する</button></div>
                        <hr>
                        <h6 class="text-muted small">投稿済みリスト</h6>
                        <ul class="list-group">
                            <li v-for="(n, i) in newsList" :key="i"
                                class="list-group-item d-flex justify-content-between align-items-center py-1"><span
                                    class="small">{{ new Date(n.date).toLocaleDateString() }} : {{ n.title
                                    }}</span><button class="btn btn-sm btn-outline-danger"
                                    @click="deleteNews(i)">削除</button></li>
                        </ul>
                    </div>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <div class="card text-bg-primary h-100">
                            <div class="card-body text-center">
                                <h6 class="card-title opacity-75">登録大学数</h6>
                                <div class="d-flex justify-content-around mt-2">
                                    <div><span class="fs-6">男子</span><br><span class="fs-2 fw-bold">{{ countMen
                                            }}</span></div>
                                    <div class="border-start border-white opacity-50"></div>
                                    <div><span class="fs-6">女子</span><br><span class="fs-2 fw-bold">{{ countWomen
                                            }}</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="card h-100 border-secondary">
                            <div class="card-body">
                                <h6 class="card-title text-muted">フィルタ</h6>
                                <div class="d-flex gap-3">
                                    <div class="form-check"><input class="form-check-input" type="radio"
                                            v-model="adminFilterType" value="all" id="af1"><label
                                            class="form-check-label" for="af1">すべて</label></div>
                                    <div class="form-check"><input class="form-check-input" type="radio"
                                            v-model="adminFilterType" value="men" id="af2"><label
                                            class="form-check-label" for="af2">男子 (1000番台)</label></div>
                                    <div class="form-check"><input class="form-check-input" type="radio"
                                            v-model="adminFilterType" value="women" id="af3"><label
                                            class="form-check-label" for="af3">女子 (2000番台)</label></div>
                                </div><input type="text" class="form-control form-control-sm mt-2"
                                    v-model="adminSearchQuery" placeholder="大学名で検索...">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="table-responsive shadow-sm border rounded" style="max-height: 70vh;">
                    <table class="table table-hover table-admin mb-0">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>大学名</th>
                                <th>請求合計</th>
                                <th>①選手登録</th>
                                <th>②連盟登録</th>
                                <th>③追加登録</th>
                                <th>④関東選手権</th>
                                <th>⑤東日本</th>
                                <th>⑥秋季L</th>
                                <th>⑦インカレ</th>
                                <th>⑧大学対抗戦</th>
                                <th>⑨新人戦</th>
                                <th>⑩経費申請</th>
                                <th>⑪返金申請</th>
                                <th>備考・連絡</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="rec in filteredAdminRecords" :key="rec.univ_id">
                                <td>{{ rec.univ_id }}</td>
                                <td class="univ-name-cell">
                                    {{ rec.univ_name }} <span class="badge bg-secondary ms-1"
                                        style="font-size:0.6rem">{{ rec.division }}部</span>
                                    <div class="small text-muted fw-normal">{{ rec.raw_data.user_name }}</div>
                                    <button class="btn btn-sm py-0 mt-1 position-relative"
                                        :class="unreadStatus[rec.univ_id] ? 'btn-danger text-white' : 'btn-outline-primary'"
                                        style="font-size: 0.75rem;" @click="openAdminChatModal(rec)">
                                        <i class="bi bi-chat-dots-fill"></i> 連絡・チャット
                                        <span v-if="unreadStatus[rec.univ_id]"
                                            class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger border border-light">!</span>
                                    </button>
                                </td>
                                <td class="money-cell fw-bold text-primary" :title="rec.cost_detail"
                                    style="cursor: help; text-decoration: underline dotted;">{{
                                    formatMoney(rec.total_cost) }}</td>
                                <td v-for="key in adminStatusKeys" :key="key" style="min-width: 100px;">
                                    <div :class="['status-badge', getAdminStatusClass(rec[key], key)]">
                                        <div v-if="key === 'add_reg'"><span class="small"
                                                v-if="rec.add_reg.length > 0">{{ rec.add_reg.length }}件申請</span><span
                                                class="small" v-else>-</span></div>
                                        <div v-else>
                                            <div v-if="rec[key].hasReceipt || rec[key].rawObj.excel_url"><button
                                                    class="btn btn-link p-0 text-decoration-none fw-bold"
                                                    :class="getAdminButtonClass(rec[key], key)"
                                                    @click="showReceipt(rec, key)"><i class="bi"
                                                        :class="rec[key].confirmed ? 'bi-check-circle-fill' : 'bi-exclamation-circle-fill'"></i>
                                                    {{ getAdminButtonText(rec[key], key) }}</button></div>
                                            <div v-else-if="rec[key].hasPaymentId"><span class="small">{{
                                                    rec[key].paymentId }}</span></div>
                                            <div v-else>-</div>
                                        </div>
                                    </div>
                                    <div class="text-center mt-1">
                                        <template v-if="key === 'add_reg'"><button v-if="rec.add_reg.length > 0"
                                                class="btn btn-sm btn-outline-secondary py-0" style="font-size: 0.7rem;"
                                                @click="openDetailModal(rec, key)"><i class="bi bi-list-ul"></i>
                                                詳細・DL</button></template>
                                        <template v-else><a v-if="rec[key].rawObj && rec[key].rawObj.excel_url"
                                                :href="rec[key].rawObj.excel_url" target="_blank"
                                                class="btn btn-sm btn-outline-success py-0"
                                                style="font-size: 0.7rem;"><i class="bi bi-file-earmark-excel-fill"></i>
                                                DL</a><button
                                                v-if="rec[key].rawObj && (rec[key].rawObj.excel_url || rec[key].rawObj.join || rec[key].rawObj.amount)"
                                                class="btn btn-sm btn-outline-secondary py-0" style="font-size: 0.7rem;"
                                                @click="openDetailModal(rec, key)"><i class="bi bi-list-ul"></i>
                                                詳細</button></template>
                                    </div>
                                </td>
                                <td style="max-width: 200px;">
                                    <div class="text-truncate small" :title="rec.memo">{{ rec.memo }}</div><button
                                        class="btn btn-sm btn-outline-danger mt-1 w-100" @click="sendAlertEmail(rec)"><i
                                            class="bi bi-envelope"></i> 不備連絡</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div v-else>
                <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom no-print">
                    <div>
                        <h4 class="m-0 d-inline-block me-3">登録管理システム</h4><span class="badge bg-secondary">{{
                            form.univ_name }} ({{ genderLabel }})</span>
                    </div>
                    <div><span class="me-3 small text-muted">{{ user ? user.email : '' }}</span><button @click="logout"
                            class="btn btn-outline-danger btn-sm">ログアウト</button></div>
                </div>

                <div class="row">
                    <div class="col-md-3 col-lg-2 mb-4 no-print">
                        <div class="list-group menu-list shadow-sm">
                            <button class="list-group-item list-group-item-action fw-bold"
                                :class="{active: activeTab === 'home'}" @click="activeTab = 'home'"><i
                                    class="bi bi-house-door-fill"></i> ホーム (連絡事項)</button>
                            <div class="list-group-item bg-light fw-bold text-muted small">登録・申請メニュー</div>

                            <button v-for="(label, key) in categoryLabels" :key="key"
                                class="list-group-item list-group-item-action" :class="{active: activeTab === key}"
                                @click="activeTab = key">

                                <div class="fw-bold">{{ label }}</div>

                                <div v-if="deadlines[key]" class="mt-1">
                                    <span class="badge rounded-pill" style="font-size: 0.75rem;"
                                        :class="isExpired(key) ? 'text-bg-danger' : 'text-bg-light border text-dark'">
                                        {{ new Date(deadlines[key]).toLocaleDateString().slice(5) }} まで
                                    </span>
                                </div>
                            </button>
                            <div class="list-group-item bg-light fw-bold text-muted small mt-2">設定・その他</div>
                            <button class="list-group-item list-group-item-action"
                                :class="{active: activeTab === 'settlement'}" @click="activeTab = 'settlement'">⑬
                                支払明細</button>
                            <button class="list-group-item list-group-item-action"
                                :class="{active: activeTab === 'account'}" @click="activeTab = 'account'">⑭
                                アカウント設定</button>
                            <button
                                class="list-group-item list-group-item-action fw-bold text-primary d-flex justify-content-between align-items-center"
                                :class="{active: activeTab === 'chat'}" @click="activeTab = 'chat'">
                                <span><i class="bi bi-chat-dots-fill"></i> ⑮ メッセージ (運営へ連絡)</span>
                                <span v-if="userHasUnread" class="badge bg-danger rounded-pill">!</span>
                            </button>
                        </div>
                    </div>

                    <div class="col-md-9 col-lg-10 mb-5">
                        <div class="card shadow-sm main-content-card">
                            <div class="card-body p-4">
                                <div v-if="activeTab === 'home'">
                                    <h4 class="mb-4 text-primary"><i class="bi bi-info-circle-fill"></i> 連絡事項・ニュース</h4>
                                    <div v-if="newsList.length === 0" class="alert alert-secondary">現在、連絡事項はありません。</div>
                                    <div v-else class="list-group">
                                        <div v-for="(news, idx) in newsList" :key="idx" class="list-group-item">
                                            <div class="d-flex w-100 justify-content-between">
                                                <h5 class="mb-1 fw-bold">{{ news.title }}</h5><small
                                                    class="text-muted">{{ new Date(news.date).toLocaleDateString()
                                                    }}</small>
                                            </div>
                                            <p class="mb-1 mt-2" style="white-space: pre-wrap;">{{ news.content }}</p>
                                            <div v-if="news.url" class="mt-2 border-top pt-2"><a :href="news.url"
                                                    target="_blank" class="btn btn-sm btn-outline-primary"><i
                                                        class="bi bi-paperclip"></i> 添付ファイルを開く</a></div>
                                        </div>
                                    </div>
                                </div>
                                <div v-if="activeTab === 'reg_fee'">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h4 class="text-primary"><i class="bi bi-people-fill"></i> ① 連盟登録 (初期) ＆ 春季リーグ
                                        </h4>
                                    </div>
                                    <div class="alert alert-info small"><i class="bi bi-exclamation-circle-fill"></i>
                                        登録用紙(Excel)をアップロードし、登録人数を入力してください。</div>
                                    <div class="excel-upload-area"><label
                                            class="form-label fw-bold">登録用紙(Excel)のアップロード</label>
                                        <div v-if="entry.reg_fee.excel_url" class="mt-3">
                                            <div class="d-flex align-items-center justify-content-center gap-2"><span
                                                    class="badge bg-success">UP済み</span><a
                                                    :href="entry.reg_fee.excel_url" target="_blank"
                                                    class="btn btn-sm btn-primary"><i class="bi bi-search"></i>
                                                    確認</a><button class="btn btn-sm btn-outline-danger"
                                                    @click="deleteExcel('reg_fee')"><i class="bi bi-trash"></i>
                                                    削除</button></div>
                                        </div>
                                        <div v-else><input type="file" class="form-control w-75 mx-auto"
                                                accept=".xlsx, .xls" @change="uploadExcel($event, 'reg_fee')">
                                            <div v-if="isUploading"
                                                class="spinner-border spinner-border-sm mt-2 text-primary"></div>
                                        </div>
                                    </div>
                                    <div class="count-input-group mb-4">
                                        <h6 class="border-bottom pb-2 mb-3">登録数入力（自動計算用）</h6>
                                        <div class="row g-3">
                                            <div class="col-md-5"><label class="form-label small fw-bold">連盟登録人数</label>
                                                <div class="input-group"><input type="number"
                                                        v-model.number="entry.reg_fee.count" class="form-control"
                                                        min="0"><span class="input-group-text">人</span></div>
                                                <div class="form-text text-end">× ¥4,000 (関東¥2,000+全日本¥2,000)</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card mb-4 border-secondary">
                                        <div class="card-body">
                                            <div class="form-check form-switch"><input class="form-check-input"
                                                    type="checkbox" v-model="entry.reg_fee.is_paid_base"
                                                    id="baseFeeCheck"><label class="form-check-label fw-bold"
                                                    for="baseFeeCheck">年度初め納入金 (¥15,000) を支払う</label></div>
                                            <div class="small text-muted ms-4 mt-1">※関東学連維持費(¥10,000) + 全日本学連加盟金(¥5,000)
                                                = ¥15,000</div>
                                        </div>
                                    </div>
                                    <div class="card border-primary mb-4">
                                        <div class="card-header bg-primary text-white bg-opacity-75"><i
                                                class="bi bi-trophy-fill"></i> 春季リーグ戦 エントリー</div>
                                        <div class="card-body">
                                            <div class="d-flex align-items-center mb-2">
                                                <div class="form-check form-switch me-4"><input class="form-check-input"
                                                        type="checkbox" v-model="entry.spring_league.join"
                                                        id="springJoin"><label class="form-check-label fw-bold"
                                                        for="springJoin">春季リーグ戦に参加する</label></div>
                                                <div v-if="entry.spring_league.join" class="d-flex align-items-center">
                                                    <label class="me-2 small fw-bold">所属部:</label><select
                                                        v-model="form.division" class="form-select form-select-sm"
                                                        style="width:auto;">
                                                        <option value="1">1部</option>
                                                        <option value="2">2部</option>
                                                        <option value="3">3部</option>
                                                        <option value="4">4部</option>
                                                        <option value="5">5部</option>
                                                        <option value="6">6部</option>
                                                    </select></div>
                                            </div>
                                            <div v-if="entry.spring_league.join" class="ms-4">
                                                <p class="mb-0 text-primary fw-bold">参加費: {{
                                                    formatMoney(calcSpringLeague) }}</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="payment-box">
                                        <div class="text-center">
                                            <h5 class="text-dark mb-1">合計支払額: <strong>{{ formatMoney(calcRegAndSpring)
                                                    }}</strong></h5>
                                            <div class="fw-bold mb-2">ゆうちょ銀行　店名：029　当座　口座番号：0080708<br>名義：関東学生バドミントン連盟
                                            </div>
                                            <p class="mb-2 text-muted small">下記番号を振込名義の前に入力してください</p>
                                            <div class="payment-id">{{ entry.reg_fee.payment_id }}</div>
                                            <div class="mt-2 text-danger fw-bold">振込名義: {{ entry.reg_fee.payment_id }}
                                                {{ form.univ_name }}</div>
                                            <div class="receipt-area">
                                                <h6 class="small fw-bold mb-3">振込明細の写真</h6>
                                                <div v-if="entry.reg_fee.receipt_url"><span
                                                        class="badge badge-uploaded mb-2"><i
                                                            class="bi bi-check-circle-fill"></i> 登録済み</span>
                                                    <div class="mb-3"><img :src="entry.reg_fee.receipt_url"
                                                            class="receipt-preview"></div>
                                                    <div class="d-flex justify-content-center gap-2"><a
                                                            :href="entry.reg_fee.receipt_url" target="_blank"
                                                            class="btn btn-sm btn-secondary"><i class="bi bi-eye"></i>
                                                            拡大</a><button class="btn btn-sm btn-outline-danger"
                                                            @click="deleteReceipt('reg_fee')"><i
                                                                class="bi bi-trash"></i> 削除</button><button
                                                            class="btn btn-sm btn-outline-dark"
                                                            @click="openReceipt('reg_fee')"><i
                                                                class="bi bi-receipt"></i> 領収書</button></div>
                                                </div>
                                                <div v-else><span class="badge badge-missing mb-2">未登録</span>
                                                    <div class="mt-2"><input type="file"
                                                            class="form-control form-control-sm w-75 mx-auto"
                                                            accept="image/*" @change="uploadReceipt($event, 'reg_fee')">
                                                        <div v-if="isUploading"
                                                            class="spinner-border spinner-border-sm mt-2"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="save-area"><button @click="saveData" class="btn btn-primary btn-lg px-5"
                                            :disabled="isSaving"><i class="bi bi-save"></i> {{ isSaving ? '保存中...' :
                                            'データを保存する' }}</button></div>
                                </div>
                                <div v-if="activeTab === 'add_reg'">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h4 class="text-success"><i class="bi bi-person-plus"></i> ③ 追加登録</h4>
                                    </div>
                                    <div v-for="(app, index) in entry.add_reg" :key="app.id"
                                        class="card mb-4 add-reg-card shadow-sm">
                                        <div class="add-reg-index">{{ index + 1 }}</div>
                                        <div
                                            class="card-header d-flex justify-content-between align-items-center bg-white border-bottom-0 pt-3">
                                            <h5 class="m-0 fw-bold text-success">申請日: {{ app.date }}</h5><span
                                                v-if="app.confirmed" class="badge bg-success">承認済み</span><span
                                                v-else-if="app.receipt_url"
                                                class="badge bg-warning text-dark">確認待ち</span><span v-else
                                                class="badge bg-secondary">未完了</span>
                                        </div>
                                        <div class="card-body">
                                            <div class="excel-upload-area"><label
                                                    class="form-label fw-bold">追加登録用紙(Excel)</label>
                                                <div v-if="app.excel_url" class="mt-3">
                                                    <div class="d-flex align-items-center justify-content-center gap-2">
                                                        <span class="badge bg-success">UP済み</span><a
                                                            :href="app.excel_url" target="_blank"
                                                            class="btn btn-sm btn-primary"><i class="bi bi-search"></i>
                                                            確認</a><button class="btn btn-sm btn-outline-danger"
                                                            @click="deleteExcelArray(index)"><i class="bi bi-trash"></i>
                                                            削除</button></div>
                                                </div>
                                                <div v-else><input type="file" class="form-control w-75 mx-auto"
                                                        accept=".xlsx, .xls" @change="uploadExcelArray($event, index)">
                                                </div>
                                            </div>
                                            <div class="row g-3 align-items-center mb-3">
                                                <div class="col-md-5"><label
                                                        class="form-label small fw-bold">追加人数</label>
                                                    <div class="input-group"><input type="number"
                                                            v-model.number="app.count" class="form-control"
                                                            min="0"><span class="input-group-text">人</span></div>
                                                </div>
                                                <div class="col-md-7">
                                                    <div class="text-end fw-bold text-success fs-5">小計: ¥{{ (app.count *
                                                        4000).toLocaleString() }}</div>
                                                </div>
                                            </div>

                                            <div class="payment-box">
                                                <div class="text-center">
                                                    <div class="fw-bold mb-2">
                                                        ゆうちょ銀行　店名：029　当座　口座番号：0080708<br>名義：関東学生バドミントン連盟</div>
                                                    <p class="mb-2 text-muted small">下記番号を振込名義の前に入力してください</p>
                                                    <div class="payment-id">{{ app.payment_id }}</div>
                                                    <div class="mt-2 text-danger fw-bold">振込名義: {{ app.payment_id }} {{
                                                        form.univ_name }}</div>
                                                    <div class="receipt-area mt-2 p-2">
                                                        <h6 class="small fw-bold mb-2">振込明細</h6>
                                                        <div v-if="app.receipt_url">
                                                            <div class="mb-2"><img :src="app.receipt_url"
                                                                    class="receipt-preview" style="max-height:150px;">
                                                            </div>
                                                            <div class="d-flex justify-content-center gap-2"><a
                                                                    :href="app.receipt_url" target="_blank"
                                                                    class="btn btn-sm btn-secondary"><i
                                                                        class="bi bi-eye"></i> 拡大</a><button
                                                                    class="btn btn-sm btn-outline-danger"
                                                                    @click="deleteReceiptArray(index)">削除</button><button
                                                                    class="btn btn-sm btn-outline-dark"
                                                                    @click="openReceiptArray(index)">領収書</button></div>
                                                        </div>
                                                        <div v-else><input type="file"
                                                                class="form-control form-control-sm w-75 mx-auto"
                                                                accept="image/*"
                                                                @change="uploadReceiptArray($event, index)"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-center mb-5"><button class="btn btn-outline-success btn-lg w-100"
                                            style="border-style: dashed;" @click="addNewReg"><i
                                                class="bi bi-plus-circle-fill"></i> 新しい申請</button></div>
                                    <div class="save-area"><button @click="saveData" class="btn btn-primary btn-lg px-5"
                                            :disabled="isSaving">データ保存</button></div>
                                </div>
                                <div v-if="activeTab === 'kanto_champ'">
                                    <h4>③ 関東学生選手権</h4>
                                    <div class="excel-upload-area"><label
                                            class="form-label fw-bold">申込ファイル(Excel)</label>
                                        <div v-if="entry.kanto_champ.excel_url" class="mt-3">
                                            <div class="d-flex align-items-center justify-content-center gap-2"><span
                                                    class="badge bg-success">UP済み</span><a
                                                    :href="entry.kanto_champ.excel_url" target="_blank"
                                                    class="btn btn-sm btn-primary"><i class="bi bi-search"></i>
                                                    確認</a><button class="btn btn-sm btn-outline-danger"
                                                    @click="deleteExcel('kanto_champ')"><i class="bi bi-trash"></i>
                                                    削除</button></div>
                                        </div>
                                        <div v-else><input type="file" class="form-control w-75 mx-auto"
                                                accept=".xlsx, .xls" @change="uploadExcel($event, 'kanto_champ')"></div>
                                    </div>
                                    <div class="count-input-group mb-4">
                                        <div class="row g-3">
                                            <div class="col-md-4"><label
                                                    class="form-label small fw-bold">シングルス</label><input type="number"
                                                    v-model.number="entry.kanto_champ.count_s" class="form-control"
                                                    min="0"></div>
                                            <div class="col-md-4"><label
                                                    class="form-label small fw-bold">ダブルス</label><input type="number"
                                                    v-model.number="entry.kanto_champ.count_d" class="form-control"
                                                    min="0"></div>
                                            <div class="col-md-4"><label
                                                    class="form-label small fw-bold">ミックス</label><input type="number"
                                                    v-model.number="entry.kanto_champ.count_m" class="form-control"
                                                    min="0"></div>
                                        </div>
                                    </div>
                                    <div class="payment-box">
                                        <div class="text-center">
                                            <h5>支払額: <strong>{{ formatMoney(calcKantoChamp) }}</strong></h5>
                                            <div class="mb-2 fw-bold">ゆうちょ銀行　店名：029　当座　口座番号：0080708<br>名義：関東学生バドミントン連盟
                                            </div>
                                            <p class="mb-2 text-muted small">下記番号を振込名義の前に入力してください</p>
                                            <div class="payment-id">{{ entry.kanto_champ.payment_id }}</div>
                                            <div class="mt-2 text-danger fw-bold">振込名義: {{ entry.kanto_champ.payment_id
                                                }} {{ form.univ_name }}</div>
                                            <div class="receipt-area">
                                                <h6 class="small fw-bold mb-3">振込明細</h6>
                                                <div v-if="entry.kanto_champ.receipt_url"><img
                                                        :src="entry.kanto_champ.receipt_url"
                                                        class="receipt-preview"><br>
                                                    <div class="d-flex justify-content-center gap-2 mt-2"><a
                                                            :href="entry.kanto_champ.receipt_url" target="_blank"
                                                            class="btn btn-sm btn-secondary"><i class="bi bi-eye"></i>
                                                            拡大</a><button class="btn btn-sm btn-outline-danger"
                                                            @click="deleteReceipt('kanto_champ')">削除</button><button
                                                            class="btn btn-sm btn-outline-dark"
                                                            @click="openReceipt('kanto_champ')">領収書</button></div>
                                                </div>
                                                <div v-else><input type="file"
                                                        class="form-control form-control-sm w-75 mx-auto"
                                                        accept="image/*" @change="uploadReceipt($event, 'kanto_champ')">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="save-area"><button @click="saveData"
                                            class="btn btn-primary btn-lg px-5">保存</button></div>
                                </div>
                                <div v-if="activeTab === 'east_japan'">
                                    <h4>④ 東日本大会</h4>
                                    <div class="excel-upload-area"><label
                                            class="form-label fw-bold">申込ファイル(Excel)</label>
                                        <div v-if="entry.east_japan.excel_url" class="mt-3">
                                            <div class="d-flex align-items-center justify-content-center gap-2"><span
                                                    class="badge bg-success">UP済み</span><a
                                                    :href="entry.east_japan.excel_url" target="_blank"
                                                    class="btn btn-sm btn-primary"><i class="bi bi-search"></i>
                                                    確認</a><button class="btn btn-sm btn-outline-danger"
                                                    @click="deleteExcel('east_japan')"><i class="bi bi-trash"></i>
                                                    削除</button></div>
                                        </div>
                                        <div v-else><input type="file" class="form-control w-75 mx-auto"
                                                accept=".xlsx, .xls" @change="uploadExcel($event, 'east_japan')"></div>
                                    </div>
                                    <div class="count-input-group mb-4">
                                        <div class="row g-3">
                                            <div class="col-md-6"><label>団体チーム数</label><input type="number"
                                                    v-model.number="entry.east_japan.team" class="form-control"></div>
                                            <div class="col-md-6"><label>運営費人数</label><input type="number"
                                                    v-model.number="entry.east_japan.ops" class="form-control"></div>
                                            <div class="col-md-4"><label>シングルス</label><input type="number"
                                                    v-model.number="entry.east_japan.count_s" class="form-control">
                                            </div>
                                            <div class="col-md-4"><label>ダブルス</label><input type="number"
                                                    v-model.number="entry.east_japan.count_d" class="form-control">
                                            </div>
                                            <div class="col-md-4"><label>ミックス</label><input type="number"
                                                    v-model.number="entry.east_japan.count_m" class="form-control">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="payment-box">
                                        <div class="text-center">
                                            <h5>支払額: <strong>{{ formatMoney(calcEastJapan) }}</strong></h5>
                                            <div class="mb-2 fw-bold">ゆうちょ銀行　店名：029　当座　口座番号：0080708<br>名義：関東学生バドミントン連盟
                                            </div>
                                            <p class="mb-2 text-muted small">下記番号を振込名義の前に入力してください</p>
                                            <div class="payment-id">{{ entry.east_japan.payment_id }}</div>
                                            <div class="mt-2 text-danger fw-bold">振込名義: {{ entry.east_japan.payment_id
                                                }} {{ form.univ_name }}</div>
                                            <div class="receipt-area">
                                                <div v-if="entry.east_japan.receipt_url"><img
                                                        :src="entry.east_japan.receipt_url" class="receipt-preview"><br>
                                                    <div class="d-flex justify-content-center gap-2 mt-2"><a
                                                            :href="entry.east_japan.receipt_url" target="_blank"
                                                            class="btn btn-sm btn-secondary"><i class="bi bi-eye"></i>
                                                            拡大</a><button class="btn btn-sm btn-outline-danger"
                                                            @click="deleteReceipt('east_japan')">削除</button><button
                                                            class="btn btn-sm btn-outline-dark"
                                                            @click="openReceipt('east_japan')">領収書</button></div>
                                                </div>
                                                <div v-else><input type="file"
                                                        class="form-control form-control-sm w-75 mx-auto"
                                                        accept="image/*" @change="uploadReceipt($event, 'east_japan')">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="save-area"><button @click="saveData"
                                            class="btn btn-primary btn-lg px-5">保存</button></div>
                                </div>
                                <div v-if="activeTab === 'autumn_league'">
                                    <h4>⑤ 秋季リーグ</h4>
                                    <div class="excel-upload-area"><label
                                            class="form-label fw-bold">申込ファイル(Excel)</label>
                                        <div v-if="entry.autumn_league.excel_url" class="mt-3">
                                            <div class="d-flex align-items-center justify-content-center gap-2"><span
                                                    class="badge bg-success">UP済み</span><a
                                                    :href="entry.autumn_league.excel_url" target="_blank"
                                                    class="btn btn-sm btn-primary"><i class="bi bi-search"></i>
                                                    確認</a><button class="btn btn-sm btn-outline-danger"
                                                    @click="deleteExcel('autumn_league')"><i class="bi bi-trash"></i>
                                                    削除</button></div>
                                        </div>
                                        <div v-else><input type="file" class="form-control w-75 mx-auto"
                                                accept=".xlsx, .xls" @change="uploadExcel($event, 'autumn_league')">
                                        </div>
                                    </div>
                                    <div class="card border-primary mb-4">
                                        <div class="card-body">
                                            <div class="form-check form-switch"><input class="form-check-input"
                                                    type="checkbox" v-model="entry.autumn_league.join"><label
                                                    class="form-check-label fw-bold">参加する</label></div>
                                            <div v-if="entry.autumn_league.join" class="mt-2">参加費: {{
                                                formatMoney(calcAutumnLeague) }}</div>
                                        </div>
                                    </div>
                                    <div class="payment-box">
                                        <div class="text-center">
                                            <h5>支払額: <strong>{{ formatMoney(calcAutumnLeague) }}</strong></h5>
                                            <div class="mb-2 fw-bold">ゆうちょ銀行　店名：029　当座　口座番号：0080708<br>名義：関東学生バドミントン連盟
                                            </div>
                                            <p class="mb-2 text-muted small">下記番号を振込名義の前に入力してください</p>
                                            <div class="payment-id">{{ entry.autumn_league.payment_id }}</div>
                                            <div class="mt-2 text-danger fw-bold">振込名義: {{
                                                entry.autumn_league.payment_id }} {{ form.univ_name }}</div>
                                            <div class="receipt-area">
                                                <div v-if="entry.autumn_league.receipt_url"><img
                                                        :src="entry.autumn_league.receipt_url"
                                                        class="receipt-preview"><br>
                                                    <div class="d-flex justify-content-center gap-2 mt-2"><a
                                                            :href="entry.autumn_league.receipt_url" target="_blank"
                                                            class="btn btn-sm btn-secondary"><i class="bi bi-eye"></i>
                                                            拡大</a><button class="btn btn-sm btn-outline-danger"
                                                            @click="deleteReceipt('autumn_league')">削除</button><button
                                                            class="btn btn-sm btn-outline-dark"
                                                            @click="openReceipt('autumn_league')">領収書</button></div>
                                                </div>
                                                <div v-else><input type="file"
                                                        class="form-control form-control-sm w-75 mx-auto"
                                                        accept="image/*"
                                                        @change="uploadReceipt($event, 'autumn_league')"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="save-area"><button @click="saveData"
                                            class="btn btn-primary btn-lg px-5">保存</button></div>
                                </div>
                                <div v-if="activeTab === 'all_japan_champ'">
                                    <h4>⑥ インカレ</h4>
                                    <div class="excel-upload-area"><label
                                            class="form-label fw-bold">申込ファイル(Excel)</label>
                                        <div v-if="entry.all_japan_champ.excel_url" class="mt-3">
                                            <div class="d-flex align-items-center justify-content-center gap-2"><span
                                                    class="badge bg-success">UP済み</span><a
                                                    :href="entry.all_japan_champ.excel_url" target="_blank"
                                                    class="btn btn-sm btn-primary"><i class="bi bi-search"></i>
                                                    確認</a><button class="btn btn-sm btn-outline-danger"
                                                    @click="deleteExcel('all_japan_champ')"><i class="bi bi-trash"></i>
                                                    削除</button></div>
                                        </div>
                                        <div v-else><input type="file" class="form-control w-75 mx-auto"
                                                accept=".xlsx, .xls" @change="uploadExcel($event, 'all_japan_champ')">
                                        </div>
                                    </div>
                                    <div class="count-input-group mb-4">
                                        <div class="row g-3">
                                            <div class="col-md-6"><label>運営費種目数</label><input type="number"
                                                    v-model.number="entry.all_japan_champ.ops_events"
                                                    class="form-control"></div>
                                            <div class="col-md-6"></div>
                                            <div class="col-md-4"><label>シングルス</label><input type="number"
                                                    v-model.number="entry.all_japan_champ.count_s" class="form-control">
                                            </div>
                                            <div class="col-md-4"><label>ダブルス</label><input type="number"
                                                    v-model.number="entry.all_japan_champ.count_d" class="form-control">
                                            </div>
                                            <div class="col-md-4"><label>ミックス</label><input type="number"
                                                    v-model.number="entry.all_japan_champ.count_m" class="form-control">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="payment-box">
                                        <div class="text-center">
                                            <h5>支払額: <strong>{{ formatMoney(calcAllJapanChamp) }}</strong></h5>
                                            <div class="mb-2 fw-bold">ゆうちょ銀行　店名：029　当座　口座番号：0080708<br>名義：関東学生バドミントン連盟
                                            </div>
                                            <p class="mb-2 text-muted small">下記番号を振込名義の前に入力してください</p>
                                            <div class="payment-id">{{ entry.all_japan_champ.payment_id }}</div>
                                            <div class="mt-2 text-danger fw-bold">振込名義: {{
                                                entry.all_japan_champ.payment_id }} {{ form.univ_name }}</div>
                                            <div class="receipt-area">
                                                <div v-if="entry.all_japan_champ.receipt_url"><img
                                                        :src="entry.all_japan_champ.receipt_url"
                                                        class="receipt-preview"><br>
                                                    <div class="d-flex justify-content-center gap-2 mt-2"><a
                                                            :href="entry.all_japan_champ.receipt_url" target="_blank"
                                                            class="btn btn-sm btn-secondary"><i class="bi bi-eye"></i>
                                                            拡大</a><button class="btn btn-sm btn-outline-danger"
                                                            @click="deleteReceipt('all_japan_champ')">削除</button><button
                                                            class="btn btn-sm btn-outline-dark"
                                                            @click="openReceipt('all_japan_champ')">領収書</button></div>
                                                </div>
                                                <div v-else><input type="file"
                                                        class="form-control form-control-sm w-75 mx-auto"
                                                        accept="image/*"
                                                        @change="uploadReceipt($event, 'all_japan_champ')"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="save-area"><button @click="saveData"
                                            class="btn btn-primary btn-lg px-5">保存</button></div>
                                </div>
                                <div v-if="activeTab === 'all_japan_team'">
                                    <h4>⑧ 大学対抗戦</h4>
                                    <div class="card border-primary mb-4">
                                        <div class="card-body">
                                            <div class="form-check form-switch"><input class="form-check-input"
                                                    type="checkbox" v-model="entry.all_japan_team.join"><label
                                                    class="form-check-label fw-bold">参加する</label></div>
                                        </div>
                                    </div>
                                    <div v-if="entry.all_japan_team.join">
                                        <div class="excel-upload-area"><label class="form-label fw-bold">申込Excel</label>
                                            <div v-if="entry.all_japan_team.excel_url" class="mt-3">
                                                <div class="d-flex align-items-center justify-content-center gap-2">
                                                    <span class="badge bg-success">UP済み</span><a
                                                        :href="entry.all_japan_team.excel_url" target="_blank"
                                                        class="btn btn-sm btn-primary"><i class="bi bi-search"></i>
                                                        確認</a><button class="btn btn-sm btn-outline-danger"
                                                        @click="deleteExcel('all_japan_team')"><i
                                                            class="bi bi-trash"></i> 削除</button></div>
                                            </div>
                                            <div v-else><input type="file" class="form-control w-75 mx-auto"
                                                    accept=".xlsx, .xls"
                                                    @change="uploadExcel($event, 'all_japan_team')"></div>
                                        </div>
                                        <div class="row g-3">
                                            <div class="col-6"><label>チーム数</label><input type="number"
                                                    v-model.number="entry.all_japan_team.team" class="form-control">
                                            </div>
                                            <div class="col-6"><label>運営費</label><input type="number"
                                                    v-model.number="entry.all_japan_team.ops" class="form-control">
                                            </div>
                                        </div>
                                        <div class="payment-box">
                                            <div class="text-center">
                                                <h5>支払額: <strong>{{ formatMoney(calcAllJapanTeam) }}</strong></h5>
                                                <div class="mb-2 fw-bold">
                                                    ゆうちょ銀行　店名：029　当座　口座番号：0080708<br>名義：関東学生バドミントン連盟</div>
                                                <p class="mb-2 text-muted small">下記番号を振込名義の前に入力してください</p>
                                                <div class="payment-id">{{ entry.all_japan_team.payment_id }}</div>
                                                <div class="mt-2 text-danger fw-bold">振込名義: {{
                                                    entry.all_japan_team.payment_id }} {{ form.univ_name }}</div>
                                                <div class="receipt-area">
                                                    <div v-if="entry.all_japan_team.receipt_url"><img
                                                            :src="entry.all_japan_team.receipt_url"
                                                            class="receipt-preview"><br>
                                                        <div class="d-flex justify-content-center gap-2 mt-2"><a
                                                                :href="entry.all_japan_team.receipt_url" target="_blank"
                                                                class="btn btn-sm btn-secondary"><i
                                                                    class="bi bi-eye"></i> 拡大</a><button
                                                                class="btn btn-sm btn-outline-danger"
                                                                @click="deleteReceipt('all_japan_team')">削除</button><button
                                                                class="btn btn-sm btn-outline-dark"
                                                                @click="openReceipt('all_japan_team')">領収書</button>
                                                        </div>
                                                    </div>
                                                    <div v-else><input type="file"
                                                            class="form-control form-control-sm w-75 mx-auto"
                                                            accept="image/*"
                                                            @change="uploadReceipt($event, 'all_japan_team')"></div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="save-area"><button @click="saveData"
                                                class="btn btn-primary btn-lg px-5">保存</button></div>
                                    </div>
                                </div>
                                <div v-if="activeTab === 'rookie'">
                                    <h4>⑧ 新人戦</h4>
                                    <div class="excel-upload-area"><label class="form-label fw-bold">申込Excel</label>
                                        <div v-if="entry.rookie.excel_url" class="mt-3">
                                            <div class="d-flex align-items-center justify-content-center gap-2"><span
                                                    class="badge bg-success">UP済み</span><a
                                                    :href="entry.rookie.excel_url" target="_blank"
                                                    class="btn btn-sm btn-primary"><i class="bi bi-search"></i>
                                                    確認</a><button class="btn btn-sm btn-outline-danger"
                                                    @click="deleteExcel('rookie')"><i class="bi bi-trash"></i>
                                                    削除</button></div>
                                        </div>
                                        <div v-else><input type="file" class="form-control w-75 mx-auto"
                                                accept=".xlsx, .xls" @change="uploadExcel($event, 'rookie')"></div>
                                    </div>
                                    <div class="count-input-group mb-4">
                                        <div class="row g-3">
                                            <div class="col-6"><label>団体A</label><input type="number"
                                                    v-model.number="entry.rookie.team_a" class="form-control"></div>
                                            <div class="col-6"><label>団体B</label><input type="number"
                                                    v-model.number="entry.rookie.team_b" class="form-control"></div>
                                            <div class="col-6"><label>シングルス</label><input type="number"
                                                    v-model.number="entry.rookie.count_s" class="form-control"></div>
                                            <div class="col-6"><label>ダブルス</label><input type="number"
                                                    v-model.number="entry.rookie.count_d" class="form-control"></div>
                                        </div>
                                    </div>
                                    <div class="payment-box">
                                        <div class="text-center">
                                            <h5>支払額: <strong>{{ formatMoney(calcRookie) }}</strong></h5>
                                            <div class="mb-2 fw-bold">ゆうちょ銀行　店名：029　当座　口座番号：0080708<br>名義：関東学生バドミントン連盟
                                            </div>
                                            <p class="mb-2 text-muted small">下記番号を振込名義の前に入力してください</p>
                                            <div class="payment-id">{{ entry.rookie.payment_id }}</div>
                                            <div class="mt-2 text-danger fw-bold">振込名義: {{ entry.rookie.payment_id }} {{
                                                form.univ_name }}</div>
                                            <div class="receipt-area">
                                                <div v-if="entry.rookie.receipt_url"><img
                                                        :src="entry.rookie.receipt_url" class="receipt-preview"><br>
                                                    <div class="d-flex justify-content-center gap-2 mt-2"><a
                                                            :href="entry.rookie.receipt_url" target="_blank"
                                                            class="btn btn-sm btn-secondary"><i class="bi bi-eye"></i>
                                                            拡大</a><button class="btn btn-sm btn-outline-danger"
                                                            @click="deleteReceipt('rookie')">削除</button><button
                                                            class="btn btn-sm btn-outline-dark"
                                                            @click="openReceipt('rookie')">領収書</button></div>
                                                </div>
                                                <div v-else><input type="file"
                                                        class="form-control form-control-sm w-75 mx-auto"
                                                        accept="image/*" @change="uploadReceipt($event, 'rookie')">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="save-area"><button @click="saveData"
                                            class="btn btn-primary btn-lg px-5">保存</button></div>
                                </div>

                                <div v-if="activeTab === 'player_reg'">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h4 class="text-primary fw-bold"><i class="bi bi-people-fill"></i> ① 選手登録　</h4>
                                    </div>
                                    <div class="alert alert-light border small"><i class="bi bi-info-circle"></i>
                                        必要な人数分を入力し、各選手の「会員証画像」をアップロードしてください。</div>

                                    <div class="table-responsive shadow-sm border rounded mb-3 bg-white">
                                        <table
                                            class="table table-bordered table-striped table-hover align-middle mb-0 text-nowrap"
                                            style="min-width: 800px;">
                                            <thead class="table-dark">
                                                <tr class="text-center small">
                                                    <th style="width: 5%">No.</th>
                                                    <th style="width: 20%">氏名</th>
                                                    <th style="width: 20%">フリガナ</th>
                                                    <th style="width: 15%">会員番号</th>
                                                    <th style="width: 10%">3級審判</th>
                                                    <th style="width: 25%">会員証画像</th>
                                                    <th style="width: 5%">削除</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr v-for="(player, index) in entry.player_reg" :key="index">
                                                    <td class="text-center fw-bold">{{ index + 1 }}</td>
                                                    <td><input type="text" v-model="player.name"
                                                            class="form-control form-control-sm" placeholder="山田 太郎">
                                                    </td>
                                                    <td><input type="text" v-model="player.kana"
                                                            class="form-control form-control-sm" placeholder="ヤマダ タロウ">
                                                    </td>
                                                    <td><input type="text" v-model="player.member_id"
                                                            class="form-control form-control-sm" placeholder="1234567">
                                                    </td>
                                                    <td>
                                                        <select v-model="player.is_referee"
                                                            class="form-select form-select-sm text-center">
                                                            <option value="無">無</option>
                                                            <option value="有">有</option>
                                                        </select>
                                                    </td>
                                                    <td class="text-center">
                                                        <div v-if="player.receipt_url"
                                                            class="d-flex align-items-center justify-content-center gap-2">
                                                            <span class="badge bg-success">登録済</span>
                                                            <a :href="player.receipt_url" target="_blank"
                                                                class="btn btn-xs btn-outline-primary py-0"
                                                                style="font-size:0.7rem">確認</a>
                                                            <i class="bi bi-x-circle-fill text-danger"
                                                                style="cursor:pointer"
                                                                @click="player.receipt_url=''"></i>
                                                        </div>
                                                        <div v-else>
                                                            <label class="btn btn-sm btn-outline-secondary py-0 w-100">
                                                                <i class="bi bi-upload"></i> 画像選択
                                                                <input type="file" style="display:none" accept="image/*"
                                                                    @change="uploadPlayerReceipt($event, index)">
                                                            </label>
                                                        </div>
                                                    </td>
                                                    <td class="text-center">
                                                        <button class="btn btn-sm btn-outline-danger border-0"
                                                            @click="removePlayerRow(index)" tabindex="-1">
                                                            <i class="bi bi-trash-fill"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>

                                    <div class="d-flex justify-content-center mb-5">
                                        <button class="btn btn-success rounded-pill px-4" @click="addPlayerRow">
                                            <i class="bi bi-plus-lg"></i> 選手を追加する
                                        </button>
                                    </div>

                                    <div class="save-area">
                                        <button @click="saveData" class="btn btn-primary btn-lg px-5">保存</button>
                                    </div>
                                </div>

                                <div v-if="activeTab === 'league_expense'">
                                    <h4>⑩ 経費申請</h4>
                                    <div class="excel-upload-area"><label class="form-label fw-bold">申請書Excel</label>
                                        <div v-if="entry.league_expense.excel_url" class="mt-3">
                                            <div class="d-flex align-items-center justify-content-center gap-2"><span
                                                    class="badge bg-success">UP済み</span><a
                                                    :href="entry.league_expense.excel_url" target="_blank"
                                                    class="btn btn-sm btn-primary"><i class="bi bi-search"></i>
                                                    確認</a><button class="btn btn-sm btn-outline-danger"
                                                    @click="deleteExcel('league_expense')"><i class="bi bi-trash"></i>
                                                    削除</button></div>
                                        </div>
                                        <div v-else><input type="file" class="form-control w-75 mx-auto"
                                                accept=".xlsx, .xls" @change="uploadExcel($event, 'league_expense')">
                                        </div>
                                    </div>
                                    <div class="mt-3"><label>申請金額</label>
                                        <div class="input-group"><span class="input-group-text">¥</span><input
                                                type="number" v-model.number="entry.league_expense.amount"
                                                class="form-control"></div>
                                    </div>
                                    <div class="text-center mt-3">
                                        <div v-if="entry.league_expense.confirmed" class="alert alert-success">振込完了
                                        </div>
                                        <div v-else class="alert alert-secondary">処理待ち</div>
                                    </div>
                                    <div class="save-area"><button @click="saveData"
                                            class="btn btn-primary btn-lg px-5">保存</button></div>
                                </div>
                                <div v-if="activeTab === 'refund_request'">
                                    <h4>⑪ 返金申請</h4>
                                    <div class="excel-upload-area"><label class="form-label fw-bold">申請書Excel</label>
                                        <div v-if="entry.refund_request.excel_url" class="mt-3">
                                            <div class="d-flex align-items-center justify-content-center gap-2"><span
                                                    class="badge bg-success">UP済み</span><a
                                                    :href="entry.refund_request.excel_url" target="_blank"
                                                    class="btn btn-sm btn-primary"><i class="bi bi-search"></i>
                                                    確認</a><button class="btn btn-sm btn-outline-danger"
                                                    @click="deleteExcel('refund_request')"><i class="bi bi-trash"></i>
                                                    削除</button></div>
                                        </div>
                                        <div v-else><input type="file" class="form-control w-75 mx-auto"
                                                accept=".xlsx, .xls" @change="uploadExcel($event, 'refund_request')">
                                        </div>
                                    </div>
                                    <div class="mt-3"><label>申請金額</label>
                                        <div class="input-group"><span class="input-group-text">¥</span><input
                                                type="number" v-model.number="entry.refund_request.amount"
                                                class="form-control"></div>
                                    </div>
                                    <div class="text-center mt-3">
                                        <div v-if="entry.refund_request.confirmed" class="alert alert-success">振込完了
                                        </div>
                                        <div v-else class="alert alert-secondary">処理待ち</div>
                                    </div>
                                    <div class="save-area"><button @click="saveData"
                                            class="btn btn-primary btn-lg px-5">保存</button></div>
                                </div>

                                <div v-if="activeTab === 'settlement'">
                                    <div class="d-flex justify-content-between align-items-center mb-4 no-print">
                                        <h4><i class="bi bi-file-earmark-spreadsheet-fill"></i> ⑫ 支払明細</h4><button
                                            onclick="window.print()" class="btn btn-dark"><i class="bi bi-printer"></i>
                                            印刷 / PDF保存</button>
                                    </div>
                                    <div class="report-container">
                                        <h3 class="text-center mb-4">令和7年度 関東学生バドミントン連盟 支払明細</h3>
                                        <div class="d-flex justify-content-between mb-3">
                                            <h5>大学名: <u>{{ form.univ_name }} ({{ genderLabel }})</u></h5>
                                            <h5>日付: <u>{{ new Date().toLocaleDateString() }}</u></h5>
                                        </div>
                                        <table class="report-table">
                                            <colgroup>
                                                <col class="col-item">
                                                <col class="col-detail">
                                                <col class="col-price">
                                            </colgroup>
                                            <thead>
                                                <tr>
                                                    <th>項目</th>
                                                    <th>詳細・内訳</th>
                                                    <th>金額</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>連盟登録費</td>
                                                    <td>基本: {{ entry.reg_fee.is_paid_base ? '¥15,000' : '¥0' }} / 登録: {{
                                                        gakurenCount }}名</td>
                                                    <td class="col-price">{{ formatMoney(calcRegFee) }}</td>
                                                </tr>
                                                <tr>
                                                    <td>春リーグ</td>
                                                    <td>{{ entry.spring_league.join ? '参加' : '不参加' }}</td>
                                                    <td class="col-price">{{ formatMoney(calcSpringLeague) }}</td>
                                                </tr>
                                                <tr>
                                                    <td>追加登録</td>
                                                    <td>{{ addRegCount }}名</td>
                                                    <td class="col-price">{{ formatMoney(calcAddReg) }}</td>
                                                </tr>
                                                <tr>
                                                    <td>関東選手権</td>
                                                    <td>S:{{entry.kanto_champ.count_s||0}} /
                                                        D:{{entry.kanto_champ.count_d||0}} /
                                                        M:{{entry.kanto_champ.count_m||0}}</td>
                                                    <td class="col-price">{{ formatMoney(calcKantoChamp) }}</td>
                                                </tr>
                                                <tr>
                                                    <td>東日本</td>
                                                    <td>団体/個人</td>
                                                    <td class="col-price">{{ formatMoney(calcEastJapan) }}</td>
                                                </tr>
                                                <tr>
                                                    <td>秋リーグ</td>
                                                    <td>{{ entry.autumn_league.join ? '参加' : '不参加' }}</td>
                                                    <td class="col-price">{{ formatMoney(calcAutumnLeague) }}</td>
                                                </tr>
                                                <tr>
                                                    <td>インカレ</td>
                                                    <td>個人</td>
                                                    <td class="col-price">{{ formatMoney(calcAllJapanChamp) }}</td>
                                                </tr>
                                                <tr>
                                                    <td>大学対抗戦</td>
                                                    <td>{{ entry.all_japan_team.join ? '参加' : '不参加' }}</td>
                                                    <td class="col-price">{{ formatMoney(calcAllJapanTeam) }}</td>
                                                </tr>
                                                <tr>
                                                    <td>新人戦</td>
                                                    <td>団体/個人</td>
                                                    <td class="col-price">{{ formatMoney(calcRookie) }}</td>
                                                </tr>
                                            </tbody>
                                            <tfoot>
                                                <tr>
                                                    <th colspan="2" class="text-center fs-5">合計</th>
                                                    <th class="col-price fs-4">{{ formatMoney(grandTotal) }}</th>
                                                </tr>
                                            </tfoot>
                                        </table>
                                        <div class="mt-5">
                                            <h6>備考・振込記録</h6><textarea v-model="memo" class="form-control d-print-none"
                                                rows="5"></textarea>
                                            <div class="d-none d-print-block memo-box">{{ memo }}</div>
                                            <div class="save-area d-print-none"><button @click="saveData"
                                                    class="btn btn-primary btn-lg px-5">保存</button></div>
                                        </div>
                                    </div>
                                </div>

                                <div v-if="activeTab === 'account'">
                                    <h4><i class="bi bi-gear-fill"></i> ⑬ アカウント設定</h4>
                                    <div class="card mt-4 border-warning">
                                        <div class="card-header bg-warning bg-opacity-10 fw-bold">メールアドレス・パスワードの変更</div>
                                        <div class="card-body">
                                            <div class="mb-3"><label class="form-label">現在のメールアドレス</label><input
                                                    type="text" class="form-control" :value="user.email" disabled></div>
                                            <hr>
                                            <div class="mb-3"><label class="form-label fw-bold">新しいメールアドレス</label><input
                                                    type="email" v-model="account.newEmail" class="form-control"></div>
                                            <div class="mb-3"><label class="form-label fw-bold">新しいパスワード</label><input
                                                    type="password" v-model="account.newPass" class="form-control">
                                            </div><button class="btn btn-warning text-dark fw-bold"
                                                @click="updateAccount">変更内容を保存</button>
                                        </div>
                                    </div>
                                </div>

                                <div v-if="activeTab === 'chat'">
                                    <h4 class="mb-3 text-primary"><i class="bi bi-chat-dots-fill"></i> ⑭ メッセージ (運営へ連絡)
                                    </h4>
                                    <div class="alert alert-light border small"><i class="bi bi-info-circle"></i>
                                        登録や申請に関する質問、不備の連絡などはここから送ってください。</div>
                                    <div class="embedded-chat">
                                        <div class="chat-body" id="chatBodyUser">
                                            <div v-if="messages.length === 0" class="text-center text-muted small mt-5">
                                                メッセージ履歴はありません。<br>困ったことがあればここに入力してください。</div>
                                            <div v-for="msg in messages" :key="msg.id" class="msg-row"
                                                :class="msg.sender === 'user' ? 'mine' : 'theirs'">
                                                <div>
                                                    <div class="msg-bubble">{{ msg.text }}</div>
                                                    <div class="d-flex align-items-center gap-2"
                                                        :class="msg.sender === 'user' ? 'justify-content-end' : 'justify-content-start'">
                                                        <i v-if="msg.sender === 'user'"
                                                            class="bi bi-trash text-secondary opacity-50"
                                                            style="cursor: pointer; font-size: 0.7rem;"
                                                            @click="deleteUserMessage(msg.id)"></i>
                                                        <div class="msg-time" v-if="msg.createdAt">{{ new
                                                            Date(msg.createdAt.seconds * 1000).toLocaleString([],
                                                            {hour:'2-digit', minute:'2-digit'}) }}</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="chat-footer">
                                            <input type="text" class="form-control" v-model="chatMessage"
                                                @keyup.enter="sendMessage(false)" placeholder="メッセージを入力...">
                                            <button class="btn btn-primary" @click="sendMessage(false)"><i
                                                    class="bi bi-send-fill"></i></button>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="showDeadlineModal" class="modal fade show d-block" style="background: rgba(0,0,0,0.5);"
            tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-warning">
                        <h5 class="modal-title fw-bold text-dark"><i class="bi bi-calendar-check"></i> 申込期限の設定</h5>
                        <button type="button" class="btn-close" @click="showDeadlineModal = false"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-light border small"><i class="bi bi-info-circle"></i>
                            設定した日付はユーザー画面に表示されます。</div>
                        <form @submit.prevent="saveDeadlines">
                            <div v-for="(label, key) in categoryLabels" :key="key" class="mb-2 row">
                                <label class="col-6 col-form-label col-form-label-sm fw-bold">{{ label }}</label>
                                <div class="col-6"><input type="date" class="form-control form-control-sm"
                                        v-model="deadlines[key]"></div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer"><button type="button" class="btn btn-secondary"
                            @click="showDeadlineModal = false">キャンセル</button><button type="button"
                            class="btn btn-primary" @click="saveDeadlines">設定を保存</button></div>
                </div>
            </div>
        </div>

        <div v-if="adminChatModal.show" class="modal fade show d-block" style="background: rgba(0,0,0,0.5);"
            tabindex="-1">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-dark text-white">
                        <h5 class="modal-title"><i class="bi bi-chat-dots"></i> {{ adminChatModal.univName }} とのチャット
                        </h5>
                        <button type="button" class="btn-close btn-close-white"
                            @click="adminChatModal.show = false"></button>
                    </div>
                    <div class="modal-body admin-chat-modal-body">
                        <div class="chat-body" id="chatBodyAdmin">
                            <div v-for="msg in adminChatMessages" :key="msg.id" class="msg-row"
                                :class="msg.sender === 'admin' ? 'mine' : 'theirs'">
                                <div>
                                    <div class="msg-bubble">{{ msg.text }}</div>
                                    <div class="d-flex align-items-center justify-content-end gap-2"><i
                                            class="bi bi-trash text-danger" style="cursor: pointer; font-size: 0.8rem;"
                                            @click="deleteAdminMessage(msg.id)" title="削除"></i>
                                        <div class="msg-time" v-if="msg.createdAt">{{ new Date(msg.createdAt.seconds *
                                            1000).toLocaleString() }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="chat-footer">
                            <input type="text" class="form-control" v-model="chatMessage"
                                @keyup.enter="sendMessage(true)" placeholder="返信を入力...">
                            <button class="btn btn-primary" @click="sendMessage(true)"><i
                                    class="bi bi-send-fill"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="detailModal.show" class="modal fade show d-block" style="background: rgba(0,0,0,0.5);" tabindex="-1">
            <div class="modal-dialog modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header bg-light py-2">
                        <h6 class="modal-title fw-bold">{{ detailModal.title }}</h6><button type="button"
                            class="btn-close small" @click="detailModal.show = false"></button>
                    </div>
                    <div class="modal-body">
                        <div v-if="detailModal.loading" class="text-center py-5">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2 text-muted">Excelファイルを読み込んでいます...</p>
                        </div>
                        <div v-else-if="detailModal.parsedData && detailModal.parsedData.length > 0">
                            <div class="alert alert-success small py-1 mb-2"><i class="bi bi-table"></i> 名簿プレビュー</div>
                            <div class="table-responsive" style="max-height: 400px;">
                                <table class="table table-sm table-bordered table-striped small mb-0 text-nowrap">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th v-for="(val, k) in detailModal.parsedData[0]" :key="k">{{ k }}</th>
                                        </tr>
                                    </thead>

                                    <tbody>
                                        <tr v-for="(row, idx) in detailModal.parsedData" :key="idx">
                                            <td v-for="(val, k) in row" :key="k">
                                                <div v-if="k === '画像'">
                                                    <a v-if="val" :href="val" target="_blank"
                                                        class="btn btn-sm btn-primary py-0" style="font-size: 0.8rem;">
                                                        <i class="bi bi-card-image"></i> 画像確認
                                                    </a>
                                                    <span v-else class="text-muted small">-</span>
                                                </div>
                                                <span v-else>{{ val }}</span>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="text-center mt-3"><button class="btn btn-sm btn-secondary"
                                    @click="detailModal.parsedData = []">一覧を閉じる</button></div>
                        </div>
                        <div v-else>
                            <div v-if="detailModal.type === 'array_list'">
                                <div class="list-group">
                                    <div v-for="(item, idx) in detailModal.data" :key="idx"
                                        class="list-group-item d-flex justify-content-between align-items-center">
                                        <div>
                                            <div class="fw-bold">申請日: {{ item.date }}</div>
                                            <div class="small">人数: {{ item.count }}名 / ID: {{ item.payment_id }}</div>
                                        </div>
                                        <div><span v-if="item.confirmed" class="badge bg-success">承認済</span><span
                                                v-else-if="item.receipt_url"
                                                class="badge bg-warning text-dark">確認中</span><span v-else
                                                class="badge bg-secondary">未完</span><a v-if="item.excel_url"
                                                :href="item.excel_url" target="_blank"
                                                class="ms-2 btn btn-sm btn-outline-primary py-0">Excel</a><button
                                                v-if="item.excel_url" class="ms-1 btn btn-sm btn-outline-info py-0"
                                                @click="previewExcel(item.excel_url)">見る</button><button
                                                v-if="item.receipt_url"
                                                class="ms-1 btn btn-sm btn-outline-secondary py-0"
                                                @click="showReceipt({univ_name:detailModal.univName}, 'add_reg', item)">振込</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div v-else-if="detailModal.type === 'entry'">
                                <div class="text-center text-muted py-4"><i
                                        class="bi bi-file-earmark-excel fs-1 text-secondary"></i>
                                    <p class="mt-2">データが表示できませんでした。<br>ダウンロードして確認してください。</p>
                                </div>
                            </div>
                            <div v-else class="text-center py-4">
                                <h5>{{ detailModal.data }}</h5>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer py-1"><button type="button" class="btn btn-sm btn-secondary"
                            @click="detailModal.show = false">閉じる</button></div>
                </div>
            </div>
        </div>

        <div v-if="receiptData.show" class="modal fade show d-block" id="receiptModal" tabindex="-1"
            style="background: rgba(0,0,0,0.5);">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">領収書プレビュー</h5><button type="button" class="btn-close"
                            @click="receiptData.show = false"></button>
                    </div>
                    <div class="modal-body bg-light p-4">
                        <div class="receipt-layout mx-auto" style="max-width: 700px;">
                            <div class="text-center"><span class="receipt-title">領　収　証</span></div>
                            <div class="d-flex justify-content-between align-items-end mt-4">
                                <h4 class="mb-0"><u>{{ form.univ_name }} 様</u></h4>
                                <div>発行日: {{ new Date().toLocaleDateString('ja-JP', {year:'numeric', month:'long',
                                    day:'numeric'}) }}</div>
                            </div>
                            <div class="receipt-amount">{{ formatMoney(receiptData.amount) }}-</div>
                            <div class="text-center small text-muted">（消費税等を含む）</div>
                            <div class="receipt-detail">
                                <p>但　{{ receiptData.title }} として<br>上記正に領収いたしました。</p>
                            </div>
                            <div class="issuer-info">
                                <div class="hanko-box"><svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"
                                        width="100%" height="100%">
                                        <rect x="2" y="2" width="96" height="96" rx="2" ry="2" fill="none" stroke="#d00"
                                            stroke-width="2" />
                                        <rect x="6" y="6" width="88" height="88" rx="1" ry="1" fill="none" stroke="#d00"
                                            stroke-width="1" /><text x="78" y="15"
                                            font-family="'Hiragino Mincho ProN', 'MS Mincho', serif" font-weight="bold"
                                            font-size="20" fill="#d00" text-anchor="middle">関</text><text x="78" y="38"
                                            font-family="'Hiragino Mincho ProN', 'MS Mincho', serif" font-weight="bold"
                                            font-size="20" fill="#d00" text-anchor="middle">東</text><text x="78" y="61"
                                            font-family="'Hiragino Mincho ProN', 'MS Mincho', serif" font-weight="bold"
                                            font-size="20" fill="#d00" text-anchor="middle">学</text><text x="78" y="84"
                                            font-family="'Hiragino Mincho ProN', 'MS Mincho', serif" font-weight="bold"
                                            font-size="20" fill="#d00" text-anchor="middle">生</text><text x="50" y="15"
                                            font-family="'Hiragino Mincho ProN', 'MS Mincho', serif" font-weight="bold"
                                            font-size="16" fill="#d00" text-anchor="middle"
                                            transform="scale(0.9, 1) translate(6,0)">バ</text><text x="50" y="38"
                                            font-family="'Hiragino Mincho ProN', 'MS Mincho', serif" font-weight="bold"
                                            font-size="16" fill="#d00" text-anchor="middle"
                                            transform="scale(0.9, 1) translate(6,0)">ド</text><text x="50" y="61"
                                            font-family="'Hiragino Mincho ProN', 'MS Mincho', serif" font-weight="bold"
                                            font-size="16" fill="#d00" text-anchor="middle"
                                            transform="scale(0.9, 1) translate(6,0)">ミ</text><text x="50" y="84"
                                            font-family="'Hiragino Mincho ProN', 'MS Mincho', serif" font-weight="bold"
                                            font-size="16" fill="#d00" text-anchor="middle"
                                            transform="scale(0.9, 1) translate(6,0)">ン</text><text x="22" y="15"
                                            font-family="'Hiragino Mincho ProN', 'MS Mincho', serif" font-weight="bold"
                                            font-size="16" fill="#d00" text-anchor="middle"
                                            transform="scale(0.9, 1) translate(2,0)">ト</text><text x="22" y="38"
                                            font-family="'Hiragino Mincho ProN', 'MS Mincho', serif" font-weight="bold"
                                            font-size="16" fill="#d00" text-anchor="middle"
                                            transform="scale(0.9, 1) translate(2,0)">ン</text><text x="22" y="61"
                                            font-family="'Hiragino Mincho ProN', 'MS Mincho', serif" font-weight="bold"
                                            font-size="20" fill="#d00" text-anchor="middle">連</text><text x="22" y="84"
                                            font-family="'Hiragino Mincho ProN', 'MS Mincho', serif" font-weight="bold"
                                            font-size="20" fill="#d00" text-anchor="middle">盟</text>
                                    </svg></div>
                                <h5>関東学生バドミントン連盟</h5>
                                <p class="small mb-0">〒272-0123</p>
                                <p class="small mb-0">千葉県市川市幸1-14-17</p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer"><button type="button" class="btn btn-secondary"
                            @click="receiptData.show = false">閉じる</button><button type="button" class="btn btn-primary"
                            onclick="window.print()"><i class="bi bi-printer"></i> 印刷 / PDF保存</button></div>
                </div>
            </div>
            <div v-if="modal.show" class="modal fade show d-block" style="background: rgba(0,0,0,0.5);" tabindex="-1">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">{{ modal.univName }} - {{ getCategoryName(modal.category) }}</h5>
                            <button type="button" class="btn-close" @click="closeModal"></button>
                        </div>
                        <div class="modal-body text-center bg-light">
                            <div v-if="modal.url">
                                <div v-if="modal.url.includes('.xlsx') || modal.url.includes('.xls')">
                                    <div class="py-5"><i class="bi bi-file-earmark-excel fs-1 text-success"></i>
                                        <p class="mt-3">Excelファイルが添付されています</p><a :href="modal.url" target="_blank"
                                            class="btn btn-success"><i class="bi bi-download"></i> ファイルを開く / ダウンロード</a>
                                    </div>
                                </div>
                                <div v-else><img :src="modal.url" class="receipt-modal-img"></div>
                            </div>
                            <div v-else class="py-5 text-muted">ファイルはありません。<br><span
                                    v-if="modal.targetRecord && modal.targetRecord[modal.category] && modal.targetRecord[modal.category].rawObj">申請額:
                                    {{ formatMoney(modal.targetRecord[modal.category].rawObj.amount) }}</span></div>
                        </div>
                        <div class="modal-footer justify-content-between">
                            <div><a v-if="modal.url" :href="modal.url" target="_blank"
                                    class="btn btn-outline-light btn-sm text-dark border-secondary">元画像を開く</a></div>
                            <div class="d-flex gap-2"><button type="button" class="btn btn-secondary"
                                    @click="closeModal">閉じる</button>
                                <div v-if="modal.category === 'add_reg'"><button v-if="!modal.subRecord.confirmed"
                                        class="btn btn-success btn-approve" @click="toggleApprovalArray(true)"><i
                                            class="bi bi-check-lg"></i> 承認する</button><button v-else
                                        class="btn btn-outline-danger" @click="toggleApprovalArray(false)">承認取消</button>
                                </div>
                                <div v-else-if="['league_expense','refund_request'].includes(modal.category)"><button
                                        v-if="!modal.targetRecord[modal.category].confirmed"
                                        class="btn btn-info btn-approve text-white" @click="toggleApproval(true)"><i
                                            class="bi bi-cash-coin"></i> 振込完了とする</button><button v-else
                                        class="btn btn-outline-danger" @click="toggleApproval(false)">振込完了を取り消す</button>
                                </div>
                                <div v-else><button v-if="!modal.targetRecord[modal.category].confirmed"
                                        class="btn btn-success btn-approve" @click="toggleApproval(true)"><i
                                            class="bi bi-check-lg"></i> 承認する</button><button v-else
                                        class="btn btn-outline-danger" @click="toggleApproval(false)">承認取消</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwn1trtYzNfHMf5D-_lUrHO3v6PguJ5XNsoWmdA_xGokuSElK5luk81OURxDhiaoMVj2Q/exec";

            const firebaseConfig = {
                apiKey: "AIzaSyASxcZep_OpFzc2EML2sUMRuK8rDJXv-cg",
                authDomain: "kanto-badminton-app.firebaseapp.com",
                projectId: "kanto-badminton-app",
                storageBucket: "kanto-badminton-app.firebasestorage.app",
                messagingSenderId: "64616841162",
                appId: "1:64616841162:web:aa78e54f507bd502de5933",
            };

            const ADMIN_ID = "admin";
            const ADMIN_PASS = "admin1234";

            firebase.initializeApp(firebaseConfig);
            const { createApp } = Vue;
            const db = firebase.firestore();

            createApp({
                data() {
                    return {
                        user: null, isAdmin: false, authEmail: '', authPass: '', authName: '', isRegisterMode: false, regGender: '1',
                        regForm: { univ_id: '' }, regError: '', regUnivName: '', searchQuery: '',
                        isLoading: false, isSaving: false, isUploading: false,
                        masterData: [], savedRecords: [], newsList: [], activeTab: 'home',

                        // --- チャット関連 ---
                        chatMessage: '',
                        messages: [],
                        chatUnsubscribe: null,
                        userHasUnread: false, // ユーザーの未読状態

                        adminActiveChatUnivId: null,
                        adminChatModal: { show: false, univName: '' },
                        adminChatMessages: [],
                        adminChatUnsubscribe: null,
                        unreadStatus: {}, // 管理者の未読状態管理 { univId: boolean }
                        // --------------------

                        // --- 期限管理 ---
                        deadlines: {}, showDeadlineModal: false,
                        categoryLabels: {
                            player_reg: '① 選手登録', // ← 先頭へ移動
                            reg_fee: '② 連盟登録',
                            add_reg: '③ 追加登録',
                            kanto_champ: '④ 関東選手権',
                            east_japan: '⑤ 東日本',
                            autumn_league: '⑥ 秋季リーグ',
                            all_japan_champ: '⑦ インカレ',
                            all_japan_team: '⑧ 大学対抗戦',
                            rookie: '⑨ 新人戦',
                            league_expense: '⑩ 経費申請',
                            refund_request: '⑪ 返金申請'
                        },

                        adminNews: { date: '', title: '', content: '', url: '' }, isUploadingNews: false,
                        account: { newEmail: '', newPass: '' }, form: { univ_id: '', univ_name: '', user_name: '', division: '3' },
                        memo: '', saveMessage: '',
                        entry: {
                            reg_fee: { excel_url: '', count: 0, payment_id: '', receipt_url: '', is_paid_base: false },
                            add_reg: [], spring_league: { join: false }, autumn_league: { join: false, excel_url: '', payment_id: '', receipt_url: '' },
                            kanto_champ: { excel_url: '', count_s: 0, count_d: 0, count_m: 0, payment_id: '', receipt_url: '' },
                            east_japan: { excel_url: '', team: 0, ops: 0, count_s: 0, count_d: 0, count_m: 0, payment_id: '', receipt_url: '' },
                            all_japan_champ: { excel_url: '', ops_events: 0, count_s: 0, count_d: 0, count_m: 0, payment_id: '', receipt_url: '' },
                            all_japan_team: { join: false, excel_url: '', team: 1, ops: 1, payment_id: '', receipt_url: '' },
                            rookie: { excel_url: '', team_a: 0, team_b: 0, count_s: 0, count_d: 0, payment_id: '', receipt_url: '' },

                            player_reg: [
                                { name: '', kana: '', member_id: '', is_referee: '無', receipt_url: '' }
                            ],
                            league_expense: { excel_url: '', amount: 0, confirmed: false }, refund_request: { excel_url: '', amount: 0, confirmed: false }
                        },
                        adminFilterType: 'all', adminSearchQuery: '',
                        adminStatusKeys: [
                            'player_reg',       // ① 選手登録
                            'reg_fee',          // ② 連盟登録
                            'add_reg',          // ③ 追加登録
                            'kanto_champ',      // ④ 関東選手権
                            'east_japan',       // ⑤ 東日本
                            'autumn_league',    // ⑥ 秋季L
                            'all_japan_champ',  // ⑦ インカレ
                            'all_japan_team',   // ⑧ 大学対抗戦
                            'rookie',           // ⑨ 新人戦
                            'league_expense',   // ⑩ 経費申請
                            'refund_request'    // ⑪ 返金申請
                        ],
                        selectedTournament: 'reg_fee', isZipping: false, isGeneratingList: false,
                        modal: { show: false, univName: '', category: '', url: '', subRecord: null },
                        detailModal: { show: false, title: '', type: '', data: null, univName: '', loading: false, parsedData: [] },
                        receiptData: { show: false, amount: 0, title: '' }, parsedMemberList: []
                    }
                },
                computed: {
                    filteredUnivList() {
                        if (!this.masterData.length) return [];
                        let list = this.masterData.filter(m => String(m.univ_id).startsWith(this.regGender));
                        if (this.searchQuery) { const q = this.searchQuery.toLowerCase(); list = list.filter(m => m.univ_name.toLowerCase().includes(q)); }
                        return list;
                    },
                    genderLabel() { if (!this.form.univ_id) return '-'; const s = String(this.form.univ_id); return s.startsWith('1') ? '男子' : s.startsWith('2') ? '女子' : '不明'; },
                    gakurenCount() { return this.entry.reg_fee.count || 0; },
                    addRegCount() { if (!Array.isArray(this.entry.add_reg)) return 0; return this.entry.add_reg.reduce((sum, item) => sum + (item.count || 0), 0); },
                    calcRegFee() { return (this.entry.reg_fee.is_paid_base ? 15000 : 0) + (4000 * this.gakurenCount); },
                    calcSpringLeague() { return this.entry.spring_league.join ? this.getLeagueFee(this.form.division) : 0; },
                    calcRegAndSpring() { return this.calcRegFee + this.calcSpringLeague; },
                    calcAddReg() { return 4000 * this.addRegCount; },
                    calcAutumnLeague() { return this.entry.autumn_league.join ? this.getLeagueFee(this.form.division) : 0; },
                    calcKantoChamp() { const e = this.entry.kanto_champ; return ((e.count_s || 0) * 3000) + ((e.count_d || 0) * 6000) + ((e.count_m || 0) * 6000); },
                    calcEastJapan() { const e = this.entry.east_japan; return ((e.team || 0) * 20000) + ((e.count_s || 0) * 3000) + ((e.count_d || 0) * 6000) + ((e.count_m || 0) * 6000) + ((e.ops || 0) * 2000); },
                    calcAllJapanChamp() { const e = this.entry.all_japan_champ; return ((e.count_s || 0) * 3000) + ((e.count_d || 0) * 6000) + ((e.count_m || 0) * 6000) + ((e.ops_events || 0) * 1000); },
                    calcAllJapanTeam() { if (!this.entry.all_japan_team.join) return 0; return (this.entry.all_japan_team.team * 20000) + (this.entry.all_japan_team.ops * 3000); },
                    calcRookie() { const e = this.entry.rookie; const t = (e.team_a || 0) + (e.team_b || 0); return (t * 5000) + ((e.count_s || 0) * 3000) + ((e.count_d || 0) * 6000); },
                    grandTotal() { return this.calcRegAndSpring + this.calcAddReg + this.calcAutumnLeague + this.calcKantoChamp + this.calcEastJapan + this.calcAllJapanChamp + this.calcAllJapanTeam + this.calcRookie; },
                    adminRecords() { if (!this.savedRecords) return []; return this.savedRecords.map(r => this.processAdminRecord(r)); },
                    filteredAdminRecords() {
                        let list = this.adminRecords;
                        if (this.adminFilterType === 'men') list = list.filter(r => String(r.univ_id).startsWith('1'));
                        if (this.adminFilterType === 'women') list = list.filter(r => String(r.univ_id).startsWith('2'));
                        if (this.adminSearchQuery) list = list.filter(r => r.univ_name.includes(this.adminSearchQuery));
                        return list.sort((a, b) => a.univ_id - b.univ_id);
                    },
                    countMen() { return this.adminRecords.filter(r => String(r.univ_id).startsWith('1')).length; },
                    countWomen() { return this.adminRecords.filter(r => String(r.univ_id).startsWith('2')).length; }
                },
                watch: {
                    activeTab(newVal) {
                        // ユーザーがチャットタブを開いたら既読にする
                        if (newVal === 'chat' && this.form.univ_id && !this.isAdmin) {
                            this.subscribeChat(this.form.univ_id);
                            this.markMessagesAsRead(this.form.univ_id, 'admin'); // Adminからの未読メッセージを既読に
                        }
                    }
                },
                created() {
                    this.isLoading = true;

                    // 1. ユーザー状態の監視
                    firebase.auth().onAuthStateChanged(u => {
                        this.user = u;
                        // もしデータ受信が既に終わっていれば、ここで初期化
                        if (u && this.savedRecords.length > 0) {
                            this.initUserData(u.email);
                            if (!this.isAdmin) setTimeout(() => this.initUserUnreadListener(), 1000);
                        }
                    });

                    // 2. データの取得 (GAS API)
                    fetch(GAS_API_URL + "?t=" + new Date().getTime())
                        .then(r => r.json())
                        .then(d => {
                            this.masterData = d.master;
                            this.savedRecords = d.records; // ここでデータが入る
                            this.isLoading = false;

                            // Firestoreの期限設定読み込み
                            db.collection('config').doc('tournaments').onSnapshot(doc => {
                                if (doc.exists) { this.deadlines = doc.data() || {}; }
                            });

                            // ★ここが修正ポイント★
                            // データ受信が完了した時点で、すでにログイン済みなら初期化を実行する
                            if (this.user) {
                                this.initUserData(this.user.email);
                                if (!this.isAdmin) setTimeout(() => this.initUserUnreadListener(), 1000);
                            }

                            // 管理者用の未読監視
                            if (this.isAdmin) {
                                this.initAdminUnreadListeners();
                            }
                        })
                        .catch(e => {
                            console.error(e);
                            this.isLoading = false;
                        });
                },

                methods: {
                    // --- 期限設定・共通 ---
                    saveDeadlines() {
                        if (!confirm("設定した申込期限を保存・公開しますか？")) return;
                        db.collection('config').doc('tournaments').set(this.deadlines).then(() => {
                            alert("期限設定を更新しました");
                            this.showDeadlineModal = false;
                        }).catch(error => {
                            console.error(error);
                            alert("保存に失敗しました");
                        });
                    },
                    isExpired(key) {
                        if (!this.deadlines[key]) return false;
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        return today > new Date(this.deadlines[key]);
                    },

                    // --- 選手登録（一括入力）関連 ---
                    addPlayerRow() {
                        this.entry.player_reg.push({
                            name: '',
                            kana: '',
                            member_id: '',
                            is_referee: '無',
                            receipt_url: ''
                        });
                    },
                    removePlayerRow(index) {
                        if (this.entry.player_reg.length <= 1) {
                            alert("これ以上削除できません");
                            return;
                        }
                        this.entry.player_reg.splice(index, 1);
                    },
                    uploadPlayerReceipt(event, index) {
                        const file = event.target.files[0];
                        if (!file) return;
                        this.isUploading = true;
                        const path = `receipts/${this.form.univ_id}/player_reg_${index}_${Date.now()}`;
                        firebase.storage().ref().child(path).put(file).then(s => s.ref.getDownloadURL()).then(url => {
                            this.entry.player_reg[index].receipt_url = url;
                            this.saveData(true);
                            this.isUploading = false;
                        }).catch(e => {
                            alert("Error: " + e.message);
                            this.isUploading = false;
                        });
                    },

                    // --- チャット機能 ---
                    async sendMessage(isFromAdmin = false) {
                        const text = this.chatMessage;
                        if (!text.trim()) return;
                        const targetUnivId = isFromAdmin ? this.adminActiveChatUnivId : this.form.univ_id;
                        if (!targetUnivId) return;
                        try {
                            await db.collection('chats').doc(String(targetUnivId)).collection('messages').add({
                                text: text,
                                sender: isFromAdmin ? 'admin' : 'user',
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                read: false
                            });
                            this.chatMessage = '';
                        } catch (e) {
                            console.error(e);
                            alert("送信失敗");
                        }
                    },
                    async markMessagesAsRead(univId, targetSender) {
                        try {
                            const batch = db.batch();
                            const snapshot = await db.collection('chats').doc(String(univId)).collection('messages')
                                .where('sender', '==', targetSender).where('read', '==', false).get();
                            if (snapshot.empty) return;
                            snapshot.forEach(doc => {
                                batch.update(doc.ref, {
                                    read: true
                                });
                            });
                            await batch.commit();
                        } catch (e) {
                            console.error("既読更新エラー", e);
                        }
                    },
                    initUserUnreadListener() {
                        if (!this.form.univ_id) return;
                        db.collection('chats').doc(String(this.form.univ_id)).collection('messages')
                            .where('sender', '==', 'admin').where('read', '==', false)
                            .onSnapshot(snapshot => {
                                this.userHasUnread = !snapshot.empty;
                            });
                    },
                    subscribeChat(univId) {
                        if (this.chatUnsubscribe) this.chatUnsubscribe();
                        if (!univId) return;
                        this.chatUnsubscribe = db.collection('chats').doc(String(univId))
                            .collection('messages').orderBy('createdAt', 'asc')
                            .onSnapshot((snapshot) => {
                                this.messages = snapshot.docs.map(doc => ({
                                    id: doc.id,
                                    ...doc.data()
                                }));
                                this.$nextTick(() => {
                                    const el = document.getElementById('chatBodyUser');
                                    if (el) el.scrollTop = el.scrollHeight;
                                });
                            });
                    },
                    async deleteUserMessage(msgId) {
                        if (!this.form.univ_id) return;
                        if (!confirm("削除しますか？")) return;
                        try {
                            await db.collection('chats').doc(String(this.form.univ_id)).collection('messages').doc(msgId).delete();
                        } catch (e) {
                            console.error(e);
                        }
                    },
                    initAdminUnreadListeners() {
                        if (!this.savedRecords) return;
                        this.savedRecords.forEach(rec => {
                            const univId = String(rec.univ_id);
                            db.collection('chats').doc(univId).collection('messages')
                                .where('sender', '==', 'user').where('read', '==', false)
                                .onSnapshot(snapshot => {
                                    this.unreadStatus[univId] = !snapshot.empty;
                                });
                        });
                    },
                    openAdminChatModal(rec) {
                        this.adminActiveChatUnivId = rec.univ_id;
                        this.adminChatModal.univName = rec.univ_name;
                        this.adminChatModal.show = true;
                        this.markMessagesAsRead(rec.univ_id, 'user');
                        if (this.adminChatUnsubscribe) this.adminChatUnsubscribe();
                        this.adminChatUnsubscribe = db.collection('chats').doc(String(rec.univ_id))
                            .collection('messages').orderBy('createdAt', 'asc')
                            .onSnapshot((snapshot) => {
                                this.adminChatMessages = snapshot.docs.map(doc => ({
                                    id: doc.id,
                                    ...doc.data()
                                }));
                                this.$nextTick(() => {
                                    const el = document.getElementById('chatBodyAdmin');
                                    if (el) el.scrollTop = el.scrollHeight;
                                });
                            });
                    },
                    async deleteAdminMessage(msgId) {
                        if (!this.adminActiveChatUnivId) return;
                        if (!confirm("削除しますか？")) return;
                        try {
                            await db.collection('chats').doc(String(this.adminActiveChatUnivId)).collection('messages').doc(msgId).delete();
                        } catch (e) {
                            console.error(e);
                        }
                    },

                    // --- ユーティリティ ---
                    formatMoney(v) {
                        if (isNaN(v) || v === null || v === undefined) return "¥0";
                        return "¥" + v.toLocaleString();
                    },
                    getLeagueFee(d) {
                        d = parseInt(d);
                        return d <= 2 ? 50000 : d <= 4 ? 20000 : 14000;
                    },

                    // --- アップロード・削除・領収書 ---
                    uploadReceipt(event, category) {
                        const file = event.target.files[0];
                        if (!file) return;
                        this.isUploading = true;
                        const path = `receipts/${this.form.univ_id}/${category}_${Date.now()}`;
                        firebase.storage().ref().child(path).put(file).then(s => s.ref.getDownloadURL()).then(url => {
                            this.entry[category].receipt_url = url;
                            this.saveData(true);
                            this.isUploading = false;
                        }).catch(e => {
                            alert("Error: " + e.message);
                            this.isUploading = false;
                        });
                    },
                    uploadReceiptArray(event, index) {
                        const file = event.target.files[0];
                        if (!file) return;
                        this.isUploading = true;
                        const path = `receipts/${this.form.univ_id}/add_reg_${index}_${Date.now()}`;
                        firebase.storage().ref().child(path).put(file).then(s => s.ref.getDownloadURL()).then(url => {
                            this.entry.add_reg[index].receipt_url = url;
                            this.saveData(true);
                            this.isUploading = false;
                        }).catch(e => {
                            alert("Error: " + e.message);
                            this.isUploading = false;
                        });
                    },
                    deleteReceipt(category) {
                        if (!confirm("削除しますか？")) return;
                        this.entry[category].receipt_url = '';
                        this.saveData(true);
                    },
                    deleteReceiptArray(index) {
                        if (!confirm("削除しますか？")) return;
                        this.entry.add_reg[index].receipt_url = '';
                        this.saveData(true);
                    },
                    deleteExcel(category) {
                        if (!confirm("Excelファイルを削除しますか？")) return;
                        this.entry[category].excel_url = '';
                        this.saveData(true);
                    },
                    deleteExcelArray(index) {
                        if (!confirm("Excelファイルを削除しますか？")) return;
                        this.entry.add_reg[index].excel_url = '';
                        this.saveData(true);
                    },

                    openReceipt(category) {
                        const amount = this.calculateCategoryTotal(category);
                        if (amount === 0) {
                            alert("金額が0円のため発行できません");
                            return;
                        }
                        this.receiptData.amount = amount;
                        this.receiptData.title = `令和7年度 ${this.getCategoryName(category)} 参加費等`;
                        this.receiptData.show = true;
                    },
                    openReceiptArray(index) {
                        const item = this.entry.add_reg[index];
                        const amount = (item.count || 0) * 4000;
                        if (amount === 0) {
                            alert("金額が0円のため発行できません");
                            return;
                        }
                        this.receiptData.amount = amount;
                        this.receiptData.title = `令和7年度 追加登録(${item.date}) 参加費等`;
                        this.receiptData.show = true;
                    },
                    calculateCategoryTotal(key) {
                        if (key === 'reg_fee') return this.calcRegAndSpring;
                        if (key === 'kanto_champ') return this.calcKantoChamp;
                        if (key === 'east_japan') return this.calcEastJapan;
                        if (key === 'autumn_league') return this.calcAutumnLeague;
                        if (key === 'all_japan_champ') return this.calcAllJapanChamp;
                        if (key === 'all_japan_team') return this.calcAllJapanTeam;
                        if (key === 'rookie') return this.calcRookie;
                        return 0;
                    },

                    uploadExcel(event, category) {
                        const file = event.target.files[0];
                        if (!file) return;
                        this.isUploading = true;
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const data = new Uint8Array(e.target.result);
                                const workbook = XLSX.read(data, {
                                    type: 'array'
                                });
                                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                                this.parsedMemberList = XLSX.utils.sheet_to_json(worksheet);
                            } catch (err) {
                                console.error(err);
                            }
                        };
                        reader.readAsArrayBuffer(file);
                        const path = `excel/${this.form.univ_id}/${category}_${Date.now()}_${file.name}`;
                        firebase.storage().ref().child(path).put(file).then(s => s.ref.getDownloadURL()).then(url => {
                            this.entry[category].excel_url = url;
                            this.saveData(true);
                            this.isUploading = false;
                            alert("ファイルをアップロードしました");
                            if (category === 'league_expense' || category === 'refund_request') this.notifyAdminUploaded(category, this.form.univ_name);
                        }).catch(e => {
                            alert("Error: " + e.message);
                            this.isUploading = false;
                        });
                    },
                    uploadExcelArray(event, index) {
                        const file = event.target.files[0];
                        if (!file) return;
                        this.isUploading = true;
                        const path = `excel/${this.form.univ_id}/add_reg_${index}_${Date.now()}_${file.name}`;
                        firebase.storage().ref().child(path).put(file).then(s => s.ref.getDownloadURL()).then(url => {
                            this.entry.add_reg[index].excel_url = url;
                            this.saveData(true);
                            this.isUploading = false;
                            alert("ファイルをアップロードしました");
                        }).catch(e => {
                            alert("Error: " + e.message);
                            this.isUploading = false;
                        });
                    },
                    notifyAdminUploaded(category, univName) {
                        const payload = {
                            action: 'send_email',
                            to: "kantogakuren.reg@gmail.com",
                            body: `${univName} 様より\n「${this.getCategoryName(category)}」の申請書類がアップロードされました。\n確認をお願いします。`
                        };
                        fetch(GAS_API_URL, {
                            method: 'POST',
                            body: JSON.stringify(payload)
                        }).catch(e => console.error(e));
                    },

                    // --- アカウント・認証 ---
                    updateAccount() {
                        const user = firebase.auth().currentUser;
                        const promises = [];
                        if (this.account.newEmail) promises.push(user.updateEmail(this.account.newEmail));
                        if (this.account.newPass) promises.push(user.updatePassword(this.account.newPass));
                        Promise.all(promises).then(() => {
                            alert("アカウント情報を更新しました");
                            if (this.account.newEmail) this.saveData(true);
                            this.account.newEmail = '';
                            this.account.newPass = '';
                        }).catch(err => {
                            alert("エラー: " + err.message);
                        });
                    },
                    toggleRegisterMode() {
                        this.isRegisterMode = true;
                        this.resetSelection();
                    },
                    resetSelection() {
                        this.regForm.univ_id = '';
                        this.regUnivName = '';
                        this.regError = '';
                        this.searchQuery = '';
                    },
                    selectUniv(u) {
                        const t = this.savedRecords.some(r => r.univ_id == u.univ_id);
                        if (t) {
                            this.regError = "登録済み";
                            this.regForm.univ_id = '';
                        } else {
                            this.regError = '';
                            this.regForm.univ_id = u.univ_id;
                            this.regUnivName = u.univ_name;
                        }
                    },
                    login() {
                        if (this.authEmail === ADMIN_ID && this.authPass === ADMIN_PASS) {
                            this.isAdmin = true;
                            this.authEmail = '';
                            this.authPass = '';
                            return;
                        }
                        firebase.auth().signInWithEmailAndPassword(this.authEmail, this.authPass).catch(e => alert(e.message));
                    },
                    resetPassword() {
                        if (!this.authEmail) {
                            alert("「メールアドレス」欄に入力してください。");
                            return;
                        }
                        if (!confirm("パスワード再設定メールを送信しますか？")) return;
                        firebase.auth().sendPasswordResetEmail(this.authEmail).then(() => alert("送信しました")).catch((e) => alert("エラー: " + e.message));
                    },
                    register() {
                        if (!this.authName) {
                            alert("氏名を入力してください");
                            return;
                        }
                        if (this.regError || !this.regUnivName) return;
                        if (!confirm("登録しますか？")) return;
                        firebase.auth().createUserWithEmailAndPassword(this.authEmail, this.authPass)
                            .then(c => {
                                this.form.univ_id = this.regForm.univ_id;
                                this.form.univ_name = this.regUnivName;
                                this.form.user_name = this.authName;
                                this.saveData(true, this.authPass);
                            })
                            .catch(e => alert(e.message));
                    },
                    logout() {
                        if (this.chatUnsubscribe) this.chatUnsubscribe();
                        if (this.adminChatUnsubscribe) this.adminChatUnsubscribe();
                        if (this.isAdmin) {
                            this.isAdmin = false;
                        } else {
                            firebase.auth().signOut();
                        }
                    },

                    // --- データ初期化 ---
                    initUserData(em) {
                        const d = this.savedRecords.find(r => r.email === em);
                        if (!d) return;

                        // 1. 基本情報のセット
                        this.form.univ_id = d.univ_id;
                        this.form.univ_name = d.univ_name;
                        this.form.user_name = d.user_name || '';
                        this.form.division = d.division;
                        if (d.memo) this.memo = d.memo;

                        // 2. データ復元用のヘルパー関数
                        // 初期値(...this.entry[key])に対して、保存データ(...saved)を上書きマージします。
                        // これにより、保存データがない場合でも初期値（0など）が消えず、計算機能が維持されます。
                        const mergeData = (key, jsonStr) => {
                            try {
                                const saved = jsonStr ? JSON.parse(jsonStr) : {};
                                // 初期値に保存データを重ねる
                                this.entry[key] = { ...this.entry[key], ...saved };
                            } catch (e) {
                                console.error(`Data Load Error (${key}):`, e);
                            }
                        };

                        // 3. 各カテゴリのデータをマージ実行
                        mergeData('reg_fee', d.reg_fee);           // ② 連盟登録
                        mergeData('spring_league', d.spring_league); // 春リーグ
                        mergeData('kanto_champ', d.kanto_champ);     // ④ 関東選手権
                        mergeData('east_japan', d.east_japan);       // ⑤ 東日本
                        mergeData('autumn_league', d.autumn_league); // ⑥ 秋季リーグ
                        mergeData('all_japan_champ', d.all_japan_champ); // ⑦ インカレ
                        mergeData('all_japan_team', d.all_japan_team);   // ⑧ 大学対抗戦
                        mergeData('rookie', d.rookie);               // ⑨ 新人戦
                        mergeData('league_expense', d.league_expense); // ⑩ 経費申請
                        mergeData('refund_request', d.refund_request); // ⑪ 返金申請

                        // 4. 配列データ（追加登録・選手登録）の特別処理
                        // 追加登録
                        try {
                            const ar = d.add_reg ? JSON.parse(d.add_reg) : [];
                            if (Array.isArray(ar)) {
                                this.entry.add_reg = ar;
                            } else if (ar.count || ar.payment_id) {
                                // 旧データ形式の場合の救済処置
                                this.entry.add_reg = [{
                                    id: 'legacy', date: '過去の申請',
                                    count: ar.count || 0, excel_url: ar.excel_url || '',
                                    payment_id: ar.payment_id || (this.form.univ_id + '02'),
                                    receipt_url: ar.receipt_url || '', confirmed: !!ar.confirmed
                                }];
                            }
                        } catch (e) { }

                        // 選手登録
                        try {
                            const pr = d.player_reg ? JSON.parse(d.player_reg) : [];
                            if (Array.isArray(pr) && pr.length > 0) {
                                this.entry.player_reg = pr;
                            }
                        } catch (e) { }

                        // 5. ID(Payment ID)の強制再設定
                        // データ読み込み後に必ずIDをセットすることで、表示されない問題を防ぎます。
                        if (this.form.univ_id) {
                            this.entry.reg_fee.payment_id = this.form.univ_id + '01';

                            // 追加登録内のID補完
                            this.entry.add_reg.forEach(item => {
                                if (!item.payment_id) item.payment_id = this.form.univ_id + '02';
                            });

                            this.entry.kanto_champ.payment_id = this.form.univ_id + '03';
                            this.entry.east_japan.payment_id = this.form.univ_id + '04';
                            this.entry.autumn_league.payment_id = this.form.univ_id + '05';
                            this.entry.all_japan_champ.payment_id = this.form.univ_id + '06';
                            this.entry.all_japan_team.payment_id = this.form.univ_id + '07';
                            this.entry.rookie.payment_id = this.form.univ_id + '08';
                        }
                    },

                    // --- データ保存 ---
                    saveDataPayload(password = null) {
                        const p = {
                            univ_id: this.form.univ_id,
                            email: this.user ? this.user.email : '',
                            univ_name: this.form.univ_name,
                            user_name: this.form.user_name,
                            division: this.form.division,
                            memo: this.memo,
                            reg_fee: this.entry.reg_fee,
                            add_reg: this.entry.add_reg,
                            spring_league: this.entry.spring_league,
                            kanto_champ: this.entry.kanto_champ,
                            east_japan: this.entry.east_japan,
                            autumn_league: this.entry.autumn_league,
                            all_japan_champ: this.entry.all_japan_champ,
                            all_japan_team: this.entry.all_japan_team,
                            rookie: this.entry.rookie,
                            // ★追加: 選手登録データ
                            player_reg: this.entry.player_reg,
                            league_expense: this.entry.league_expense,
                            refund_request: this.entry.refund_request,
                            total_cost: this.grandTotal
                        };
                        if (password) {
                            p.password = password;
                        }
                        return fetch(GAS_API_URL, {
                            method: 'POST',
                            body: JSON.stringify(p)
                        }).then(r => r.json());
                    },
                    saveData(isSilent = false, password = null) {
                        if (typeof isSilent === 'object') isSilent = false;
                        this.isSaving = true;
                        this.saveDataPayload(password).then(d => {
                            this.isSaving = false;
                            if (!isSilent) {
                                this.saveMessage = "データを保存しました";
                                setTimeout(() => {
                                    this.saveMessage = '';
                                }, 3000);
                            }
                        }).catch(e => {
                            alert("エラー");
                            this.isSaving = false;
                        });
                    },

                    // --- Excelプレビュー ---
                    async previewExcel(url) {
                        if (!url) return;
                        this.detailModal.loading = true;
                        this.detailModal.parsedData = [];
                        try {
                            const res = await fetch(url);
                            if (!res.ok) throw new Error("Fetch failed");
                            const ab = await res.arrayBuffer();
                            const wb = XLSX.read(ab, {
                                type: "array"
                            });
                            const resultList = [];
                            wb.SheetNames.forEach(sheetName => {
                                const isTeam = sheetName.includes("団体");
                                const isSingle = sheetName.includes("シングルス");
                                const isDouble = sheetName.includes("ダブルス");
                                const isMixed = sheetName.includes("ミックス");
                                if (!isTeam && !isSingle && !isDouble && !isMixed) return;
                                const ws = wb.Sheets[sheetName];
                                const data = XLSX.utils.sheet_to_json(ws, {
                                    header: 1
                                });
                                const startRow = 5;
                                for (let i = startRow; i < data.length; i += 2) {
                                    const row1 = data[i] || [];
                                    const row2 = data[i + 1] || [];
                                    if (!row1[1] && !row1[6]) continue;
                                    const createRow = (kubun, name, kana, grade, regNum) => {
                                        return {
                                            "大学名": this.detailModal.univName,
                                            "種目": sheetName,
                                            "区分": kubun,
                                            "氏名": name,
                                            "フリガナ": kana,
                                            "学年": grade,
                                            "登録番号": regNum
                                        };
                                    };
                                    if (isTeam || isSingle) {
                                        if (row1[1]) {
                                            const name = (row2[1] || "") + " " + (row2[2] || "");
                                            if (name.trim()) resultList.push(createRow(isTeam ? "A/前" : "No." + row1[0], name, (row1[1] || "") + " " + (row1[2] || ""), row1[3], row1[4]));
                                        }
                                        if (row1[6]) {
                                            const name = (row2[6] || "") + " " + (row2[7] || "");
                                            if (name.trim()) resultList.push(createRow(isTeam ? "B/後" : "No." + row1[5], name, (row1[6] || "") + " " + (row1[7] || ""), row1[8], row1[9]));
                                        }
                                    } else if (isDouble || isMixed) {
                                        if (row1[1]) {
                                            const p1 = (row2[1] || "") + " " + (row2[2] || "");
                                            const p2 = (row2[5] || "") + " " + (row2[6] || "");
                                            if (p1.trim()) {
                                                resultList.push(createRow("No." + row1[0], `${p1} / ${p2}`, `${row1[1]} ${row1[2]} / ${row1[5]} ${row1[6]}`, `${row1[3]} / ${row1[7]}`, `${row1[4] || ""} / ${row1[8] || ""}`));
                                            }
                                        }
                                    }
                                }
                            });
                            if (resultList.length > 0) this.detailModal.parsedData = resultList;
                            else {
                                const ws = wb.Sheets[wb.SheetNames[0]];
                                this.detailModal.parsedData = XLSX.utils.sheet_to_json(ws);
                            }
                        } catch (e) {
                            console.error("Excel Read Error:", e);
                            this.detailModal.parsedData = [];
                        } finally {
                            this.detailModal.loading = false;
                        }
                    },

                    // --- 管理者：ダウンロード機能 ---
                    async downloadAllParticipantsExcel() {
                        const key = this.selectedTournament;
                        const catName = this.getCategoryName(key);
                        if (!confirm(`【対象: ${catName}】\n\n表示中の全大学のExcelファイルから参加者データを抽出しますか？`)) return;
                        this.isGeneratingList = true;
                        let targets = [];
                        if (key === 'add_reg') {
                            this.filteredAdminRecords.forEach(r => {
                                if (Array.isArray(r.add_reg)) {
                                    r.add_reg.forEach(item => {
                                        if (item.excel_url) targets.push({
                                            url: item.excel_url,
                                            univName: r.univ_name
                                        });
                                    });
                                }
                            });
                        } else {
                            this.filteredAdminRecords.forEach(r => {
                                if (r[key] && r[key].rawObj && r[key].rawObj.excel_url) {
                                    targets.push({
                                        url: r[key].rawObj.excel_url,
                                        univName: r.univ_name
                                    });
                                }
                            });
                        }
                        if (targets.length === 0) {
                            alert(`ファイルが見つかりませんでした。`);
                            this.isGeneratingList = false;
                            return;
                        }
                        try {
                            const finalData = {
                                team: [],
                                single: [],
                                double: [],
                                mixed: []
                            };
                            const promises = targets.map(async (target) => {
                                try {
                                    const res = await fetch(target.url);
                                    if (!res.ok) throw new Error("Fetch failed");
                                    const ab = await res.arrayBuffer();
                                    const wb = XLSX.read(ab, {
                                        type: "array"
                                    });
                                    const localData = {
                                        team: [],
                                        single: [],
                                        double: [],
                                        mixed: []
                                    };
                                    wb.SheetNames.forEach(sheetName => {
                                        const isTeam = sheetName.includes("団体"),
                                            isSingle = sheetName.includes("シングルス"),
                                            isMixed = sheetName.includes("ミックス"),
                                            isDouble = sheetName.includes("ダブルス") && !isMixed;
                                        if (!isTeam && !isSingle && !isDouble && !isMixed) return;
                                        const ws = wb.Sheets[sheetName];
                                        const data = XLSX.utils.sheet_to_json(ws, {
                                            header: 1
                                        });
                                        const startRow = 5;
                                        for (let i = startRow; i < data.length; i += 2) {
                                            const row1 = data[i] || [],
                                                row2 = data[i + 1] || [];
                                            if (!row1[1] && !row1[6]) continue;
                                            const createRow = (kubun, name, kana, grade, regNum) => ({
                                                "大学名": target.univName,
                                                "種目": sheetName,
                                                "区分": kubun,
                                                "氏名": name,
                                                "フリガナ": kana,
                                                "学年": grade,
                                                "登録番号": regNum
                                            });
                                            if (isTeam || isSingle) {
                                                const targetList = isTeam ? localData.team : localData.single;
                                                if (row1[1]) targetList.push(createRow(isTeam ? "A/前" : "No." + row1[0], (row2[1] || "") + " " + (row2[2] || ""), (row1[1] || "") + " " + (row1[2] || ""), row1[3], row1[4]));
                                                if (row1[6]) targetList.push(createRow(isTeam ? "B/後" : "No." + row1[5], (row2[6] || "") + " " + (row2[7] || ""), (row1[6] || "") + " " + (row1[7] || ""), row1[8], row1[9]));
                                            } else if (isDouble || isMixed) {
                                                const targetList = isMixed ? localData.mixed : localData.double;
                                                if (row1[1]) targetList.push(createRow("No." + row1[0], `${row2[1] || ""} ${row2[2] || ""} / ${row2[5] || ""} ${row2[6] || ""}`, `${row1[1]} ${row1[2]} / ${row1[5]} ${row1[6]}`, `${row1[3]} / ${row1[7]}`, `${row1[4] || ""} / ${row1[8] || ""}`));
                                            }
                                        }
                                    });
                                    return localData;
                                } catch (e) {
                                    console.error(`Error loading ${target.univName}:`, e);
                                    return null;
                                }
                            });
                            const results = await Promise.all(promises);
                            results.forEach(res => {
                                if (res) {
                                    finalData.team.push(...res.team);
                                    finalData.single.push(...res.single);
                                    finalData.double.push(...res.double);
                                    finalData.mixed.push(...res.mixed);
                                }
                            });
                            if (finalData.team.length + finalData.single.length + finalData.double.length + finalData.mixed.length === 0) {
                                alert("有効な選手データが見つかりませんでした。");
                            } else {
                                const newWb = XLSX.utils.book_new();
                                if (finalData.team.length > 0) XLSX.utils.book_append_sheet(newWb, XLSX.utils.json_to_sheet(finalData.team), "団体");
                                if (finalData.single.length > 0) XLSX.utils.book_append_sheet(newWb, XLSX.utils.json_to_sheet(finalData.single), "シングルス");
                                if (finalData.double.length > 0) XLSX.utils.book_append_sheet(newWb, XLSX.utils.json_to_sheet(finalData.double), "ダブルス");
                                if (finalData.mixed.length > 0) XLSX.utils.book_append_sheet(newWb, XLSX.utils.json_to_sheet(finalData.mixed), "ミックス");
                                const wbout = XLSX.write(newWb, {
                                    bookType: 'xlsx',
                                    type: 'array'
                                });
                                saveAs(new Blob([wbout], {
                                    type: "application/octet-stream"
                                }), `全参加者名簿_${catName}.xlsx`);
                            }
                        } catch (e) {
                            console.error(e);
                            alert("エラーが発生しました。");
                        } finally {
                            this.isGeneratingList = false;
                        }
                    },
                    // ★追加: 選手登録名簿のCSVダウンロード
                    downloadPlayerRegList() {
                        let csv = "\uFEFF大学ID,大学名,No,氏名,フリガナ,会員番号,3級審判,画像URL\n";
                        this.filteredAdminRecords.forEach(rec => {
                            const players = Array.isArray(rec.player_reg.rawObj) ? rec.player_reg.rawObj : [];
                            players.forEach((p, index) => {
                                const row = [
                                    rec.univ_id,
                                    rec.univ_name,
                                    index + 1,
                                    p.name || '',
                                    p.kana || '',
                                    p.member_id || '',
                                    p.is_referee || '無',
                                    p.receipt_url || ''
                                ];
                                csv += row.join(",") + "\n";
                            });
                        });
                        const blob = new Blob([csv], {
                            type: "text/csv"
                        });
                        saveAs(blob, `全大学_選手登録名簿_${new Date().toLocaleDateString().replace(/\//g, '')}.csv`);
                    },

                    // --- データ加工・表示用 ---
                    processAdminRecord(raw) {
                        const safeParse = (json, def) => {
                            try {
                                return json ? JSON.parse(json) : def;
                            } catch (e) {
                                return def;
                            }
                        };
                        const rFee = safeParse(raw.reg_fee, {});
                        let aReg = safeParse(raw.add_reg, []);
                        if (!Array.isArray(aReg)) {
                            if (aReg.count) aReg = [aReg];
                            else aReg = [];
                        }
                        const sLig = safeParse(raw.spring_league, {});
                        const kChamp = safeParse(raw.kanto_champ, {});
                        const eJapan = safeParse(raw.east_japan, {});
                        const aLig = safeParse(raw.autumn_league, {});
                        const ajChamp = safeParse(raw.all_japan_champ, {});
                        const ajTeam = safeParse(raw.all_japan_team, {});
                        const rookie = safeParse(raw.rookie, {});
                        const lExp = safeParse(raw.league_expense, {});
                        const refReq = safeParse(raw.refund_request, {});
                        const pReg = safeParse(raw.player_reg, []);

                        let details = [];
                        if (rFee.is_paid_base) details.push(`基本金: ¥15,000`);
                        if (rFee.count && rFee.count > 0) details.push(`登録(${rFee.count}名): ¥${(rFee.count * 4000).toLocaleString()}`);
                        let totalAddCount = 0;
                        aReg.forEach(r => {
                            totalAddCount += (r.count || 0);
                        });
                        if (totalAddCount > 0) details.push(`追加(計${totalAddCount}名): ¥${(totalAddCount * 4000).toLocaleString()}`);
                        if (sLig.join) details.push(`春リーグ: ¥${this.getLeagueFee(raw.division).toLocaleString()}`);
                        if (aLig.join) details.push(`秋リーグ: ¥${this.getLeagueFee(raw.division).toLocaleString()}`);
                        if (ajTeam.join) {
                            const fee = (ajTeam.team || 0) * 20000 + (ajTeam.ops || 0) * 3000;
                            if (fee > 0) details.push(`大学対抗戦: ¥${fee.toLocaleString()}`);
                        }
                        if (rFee.excel_url) details.push(`連盟登録: Excelあり`);
                        if (aReg.some(r => r.excel_url)) details.push(`追加登録: Excelあり`);
                        if (lExp.excel_url) details.push(`経費申請: ¥${lExp.amount}`);
                        if (refReq.excel_url) details.push(`返金申請: ¥${refReq.amount}`);

                        const detailText = details.length > 0 ? details.join('\n') : "内訳なし";
                        const parseCat = (obj) => {
                            return {
                                hasPaymentId: !!obj.payment_id,
                                hasReceipt: !!obj.receipt_url,
                                receiptUrl: obj.receipt_url,
                                paymentId: obj.payment_id,
                                confirmed: !!obj.confirmed,
                                rawObj: obj
                            };
                        };

                        return {
                            univ_id: raw.univ_id,
                            univ_name: raw.univ_name,
                            division: raw.division,
                            total_cost: raw.total_cost,
                            cost_detail: detailText,
                            memo: raw.memo,
                            reg_fee: parseCat(rFee),
                            add_reg: aReg,
                            spring_league: parseCat(sLig),
                            kanto_champ: parseCat(kChamp),
                            east_japan: parseCat(eJapan),
                            autumn_league: parseCat(aLig),
                            all_japan_champ: parseCat(ajChamp),
                            all_japan_team: parseCat(ajTeam),
                            rookie: parseCat(rookie),
                            // player_reg: 配列なので簡易処理
                            player_reg: {
                                confirmed: false,
                                rawObj: pReg,
                                hasReceipt: false
                            },
                            league_expense: {
                                confirmed: !!lExp.confirmed,
                                rawObj: lExp,
                                hasReceipt: !!lExp.excel_url,
                                receiptUrl: lExp.excel_url
                            },
                            refund_request: {
                                confirmed: !!refReq.confirmed,
                                rawObj: refReq,
                                hasReceipt: !!refReq.excel_url,
                                receiptUrl: refReq.excel_url
                            },
                            raw_data: raw
                        };
                    },
                    getAdminStatusClass(cat, key) {
                        if (['league_expense', 'refund_request'].includes(key)) {
                            if (cat.confirmed) return 'status-payout-done';
                            if (cat.rawObj.excel_url) return 'status-pending';
                            return 'status-none';
                        }
                        if (key === 'player_reg') {
                            // 選手登録は件数で判断
                            const list = Array.isArray(cat.rawObj) ? cat.rawObj : [];
                            return list.length > 0 ? 'status-done' : 'status-none';
                        }
                        if (cat.confirmed) return 'status-done';
                        if (cat.hasReceipt) return 'status-pending';
                        if (cat.hasPaymentId) return 'status-waiting';
                        return 'status-none';
                    },
                    getAdminButtonText(cat, key) {
                        if (['league_expense', 'refund_request'].includes(key)) return cat.confirmed ? '振込済' : '確認';
                        if (key === 'player_reg') {
                            const list = Array.isArray(cat.rawObj) ? cat.rawObj : [];
                            return list.length > 0 ? `${list.length}名` : '-';
                        }
                        return cat.confirmed ? '承認済' : '確認';
                    },
                    getAdminButtonClass(cat, key) {
                        if (['league_expense', 'refund_request'].includes(key)) return cat.confirmed ? 'text-info' : 'text-white';
                        if (key === 'player_reg') {
                            const list = Array.isArray(cat.rawObj) ? cat.rawObj : [];
                            return list.length > 0 ? 'text-success' : 'text-muted';
                        }
                        return cat.confirmed ? 'text-success' : 'text-white';
                    },

                    toggleApprovalArray(isApprove) {
                        const item = this.modal.subRecord;
                        if (!confirm(isApprove ? "承認しますか？" : "承認を取り消しますか？")) return;
                        item.confirmed = isApprove;
                        const rec = this.modal.targetRecord;
                        this.saveTargetRecordArray(rec).then(() => {
                            alert("更新しました");
                            this.modal.show = false;
                        });
                    },
                    saveTargetRecordArray(rec) {
                        const payload = {
                            ...rec.raw_data
                        };
                        this.adminStatusKeys.forEach(key => {
                            if (key !== 'add_reg') payload[key] = JSON.stringify(rec[key].rawObj);
                        });
                        payload['add_reg'] = JSON.stringify(rec.add_reg);
                        payload.email = payload.email || 'admin_edit';
                        return fetch(GAS_API_URL, {
                            method: 'POST',
                            body: JSON.stringify(payload)
                        }).then(r => r.json()).catch(e => {
                            console.error(e);
                            alert("保存エラー");
                        });
                    },
                    toggleApproval(isApprove) {
                        const rec = this.modal.targetRecord;
                        const cat = this.modal.category;
                        const isPayout = ['league_expense', 'refund_request'].includes(cat);
                        const msg = isPayout ? (isApprove ? "振込完了としますか？" : "完了を取り消しますか？") : (isApprove ? "承認しますか？" : "承認を取り消しますか？");
                        if (!confirm(msg)) return;
                        rec[cat].confirmed = isApprove;
                        rec[cat].rawObj.confirmed = isApprove;
                        this.saveTargetRecord(rec).then(() => {
                            alert("更新しました");
                            this.modal.show = false;
                        });
                    },
                    saveTargetRecord(rec) {
                        const payload = {
                            ...rec.raw_data
                        };
                        const cats = this.adminStatusKeys;
                        cats.forEach(key => {
                            if (key === 'add_reg' || key === 'player_reg') payload[key] = JSON.stringify(rec[key].rawObj || rec[key]);
                            else payload[key] = JSON.stringify(rec[key].rawObj);
                        });
                        payload.email = payload.email || 'admin_edit';
                        return fetch(GAS_API_URL, {
                            method: 'POST',
                            body: JSON.stringify(payload)
                        }).then(r => r.json()).catch(e => {
                            console.error(e);
                            alert("保存エラー");
                        });
                    },
                    showReceipt(record, catKey, subItem = null) {
                        this.modal.univName = record.univ_name;
                        this.modal.category = catKey;
                        this.modal.targetRecord = record;
                        if (catKey === 'add_reg' && subItem) {
                            this.modal.url = subItem.receipt_url;
                            this.modal.subRecord = subItem;
                        } else {
                            this.modal.url = record[catKey].receiptUrl;
                        }
                        this.modal.show = true;
                    },

                    openDetailModal(rec, key) {
                        const raw = rec[key].rawObj;
                        let title = `${rec.univ_name} - ${this.getCategoryName(key)}`;
                        this.detailModal = {
                            show: true,
                            title: title,
                            type: '',
                            data: null,
                            univName: rec.univ_name,
                            loading: false,
                            parsedData: []
                        };

                        if (key === 'add_reg') {
                            this.detailModal.type = 'array_list';
                            this.detailModal.data = rec.add_reg;
                        } else if (key === 'player_reg') {
                            // 選手登録: 配列データを表示用テーブルに変換
                            this.detailModal.parsedData = Array.isArray(raw) ? raw.map((p, i) => ({
                                "No": i + 1,
                                "氏名": p.name,
                                "フリガナ": p.kana,
                                "会員番号": p.member_id,
                                "3級審判": p.is_referee,
                                "画像": p.receipt_url ? "あり" : "なし"
                            })) : [];
                            if (this.detailModal.parsedData.length === 0) {
                                this.detailModal.type = 'simple';
                                this.detailModal.data = "登録データなし";
                            }
                        } else {
                            if (raw.excel_url) {
                                this.detailModal.type = 'entry';
                                this.previewExcel(raw.excel_url);
                            } else {
                                this.detailModal.type = 'simple';
                                this.detailModal.data = raw.join ? '参加' : '不参加';
                            }
                        }
                    },
                    closeModal() {
                        this.modal.show = false;
                    },
                    getCategoryName(key) {
                        const names = {
                            reg_fee: '連盟登録',
                            add_reg: '追加登録',
                            kanto_champ: '関東選手権',
                            east_japan: '東日本',
                            autumn_league: '秋季リーグ',
                            all_japan_champ: 'インカレ',
                            all_japan_team: '大学対抗戦',
                            rookie: '新人戦',
                            player_reg: '選手登録',
                            league_expense: '経費申請',
                            refund_request: '返金申請'
                        };
                        return names[key] || key;
                    },

                    downloadAllCSV() {
                        let csv = "大学ID,大学名,部署,合計請求額,連盟登録Excel,追加登録Excel,関東Excel,東日本Excel,秋季L Excel,インカレExcel,大学対抗戦Excel,新人戦Excel,経費申請Excel,返金申請Excel\n";
                        this.filteredAdminRecords.forEach(r => {
                            const regExcel = r.reg_fee.rawObj.excel_url || "";
                            const addExcel = r.add_reg.map(item => item.excel_url).filter(u => u).join('; ');
                            const kExcel = r.kanto_champ.rawObj.excel_url || "";
                            const eExcel = r.east_japan.rawObj.excel_url || "";
                            const alExcel = r.autumn_league.rawObj.excel_url || "";
                            const aExcel = r.all_japan_champ.rawObj.excel_url || "";
                            const ajtExcel = r.all_japan_team.rawObj.excel_url || "";
                            const rExcel = r.rookie.rawObj.excel_url || "";
                            const lExcel = r.league_expense.rawObj.excel_url || "";
                            const refExcel = r.refund_request.rawObj.excel_url || "";
                            csv += `${r.univ_id},${r.univ_name},${r.division},${r.total_cost},${regExcel},${addExcel},${kExcel},${eExcel},${alExcel},${aExcel},${ajtExcel},${rExcel},${lExcel},${refExcel}\n`;
                        });
                        const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], {
                            type: "text/csv"
                        });
                        saveAs(blob, "kanto_badminton_summary.csv");
                    },
                    downloadTournamentCSV() {
                        const key = this.selectedTournament;
                        const headerMap = {
                            reg_fee: "大学ID,大学名,基本金有無,登録人数,ExcelURL,支払ID,承認済",
                            add_reg: "大学ID,大学名,申請日,追加人数,ExcelURL,支払ID,承認済",
                            kanto_champ: "大学ID,大学名,シングルス数,ダブルス数,ミックス数,ExcelURL,支払ID,承認済",
                            east_japan: "大学ID,大学名,チーム数,運営費人数,シングルス数,ダブルス数,ミックス数,ExcelURL,支払ID,承認済",
                            autumn_league: "大学ID,大学名,参加,ExcelURL,支払ID,承認済",
                            all_japan_champ: "大学ID,大学名,運営費種目数,シングルス数,ダブルス数,ミックス数,ExcelURL,支払ID,承認済",
                            all_japan_team: "大学ID,大学名,参加,チーム数,運営費,ExcelURL,支払ID,承認済",
                            rookie: "大学ID,大学名,団体A,団体B,シングルス数,ダブルス数,ExcelURL,支払ID,承認済",
                            league_expense: "大学ID,大学名,申請金額,ExcelURL,振込完了",
                            refund_request: "大学ID,大学名,申請金額,ExcelURL,振込完了"
                        };
                        let csv = (headerMap[key] || "大学ID,大学名,詳細") + "\n";
                        this.filteredAdminRecords.forEach(r => {
                            const base = `${r.univ_id},${r.univ_name}`;
                            if (key === 'add_reg') {
                                const list = r.add_reg;
                                if (list.length === 0) csv += `${base},,0,,,\n`;
                                else list.forEach(item => {
                                    csv += `${base},${item.date || ''},${item.count || 0},${item.excel_url || ''},${item.payment_id || ''},${item.confirmed ? 1 : 0}\n`;
                                });
                                return;
                            }
                            // 選手登録の個別CSV出力（一括DLとは別）
                            if (key === 'player_reg') {
                                const list = Array.isArray(r.player_reg.rawObj) ? r.player_reg.rawObj : [];
                                list.forEach(p => {
                                    csv += `${base},${p.name},${p.kana},${p.member_id},${p.is_referee}\n`;
                                });
                                return;
                            }
                            const raw = r[key].rawObj;
                            if (!raw) return;
                            let line = base;
                            if (key === 'reg_fee') line += `,${raw.is_paid_base ? 1 : 0},${raw.count || 0},${raw.excel_url || ''},${raw.payment_id || ''},${raw.confirmed ? 1 : 0}`;
                            else if (key === 'kanto_champ') line += `,${raw.count_s || 0},${raw.count_d || 0},${raw.count_m || 0},${raw.excel_url || ''},${raw.payment_id || ''},${raw.confirmed ? 1 : 0}`;
                            else if (key === 'east_japan') line += `,${raw.team || 0},${raw.ops || 0},${raw.count_s || 0},${raw.count_d || 0},${raw.count_m || 0},${raw.excel_url || ''},${raw.payment_id || ''},${raw.confirmed ? 1 : 0}`;
                            else if (key === 'autumn_league') line += `,${raw.join ? 1 : 0},${raw.excel_url || ''},${raw.payment_id || ''},${raw.confirmed ? 1 : 0}`;
                            else if (key === 'all_japan_champ') line += `,${raw.ops_events || 0},${raw.count_s || 0},${raw.count_d || 0},${raw.count_m || 0},${raw.excel_url || ''},${raw.payment_id || ''},${raw.confirmed ? 1 : 0}`;
                            else if (key === 'all_japan_team') line += `,${raw.join ? 1 : 0},${raw.team || 0},${raw.ops || 0},${raw.excel_url || ''},${raw.payment_id || ''},${raw.confirmed ? 1 : 0}`;
                            else if (key === 'rookie') line += `,${raw.team_a || 0},${raw.team_b || 0},${raw.count_s || 0},${raw.count_d || 0},${raw.excel_url || ''},${raw.payment_id || ''},${raw.confirmed ? 1 : 0}`;
                            else if (key === 'league_expense') line += `,${raw.amount || 0},${raw.excel_url || ''},${raw.confirmed ? 1 : 0}`;
                            else if (key === 'refund_request') line += `,${raw.amount || 0},${raw.excel_url || ''},${raw.confirmed ? 1 : 0}`;
                            csv += line + "\n";
                        });
                        const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], {
                            type: "text/csv"
                        });
                        saveAs(blob, `kanto_${key}_list.csv`);
                    },
                    downloadTournamentZip() {
                        const key = this.selectedTournament;
                        const zip = new JSZip();
                        let count = 0;
                        this.isZipping = true;
                        let targets = [];
                        if (key === 'add_reg') {
                            this.filteredAdminRecords.forEach(r => {
                                r.add_reg.forEach((item, idx) => {
                                    if (item.excel_url) {
                                        targets.push({
                                            name: `${r.univ_name}_追加登録_${item.date.replace(/\//g, '')}_${idx}.xlsx`,
                                            url: item.excel_url
                                        });
                                    }
                                });
                            });
                        } else if (key === 'player_reg') {
                            // 選手登録の画像を一括ダウンロード
                            this.filteredAdminRecords.forEach(r => {
                                const list = Array.isArray(r.player_reg.rawObj) ? r.player_reg.rawObj : [];
                                list.forEach((p, idx) => {
                                    if (p.receipt_url) {
                                        // URLから拡張子を推測、またはjpg固定
                                        let ext = "jpg";
                                        if (p.receipt_url.includes(".png")) ext = "png";
                                        targets.push({
                                            name: `${r.univ_name}_${p.name}_${idx}.${ext}`,
                                            url: p.receipt_url
                                        });
                                    }
                                });
                            });
                        } else {
                            targets = this.filteredAdminRecords.filter(r => r[key].rawObj && r[key].rawObj.excel_url)
                                .map(r => ({
                                    name: `${r.univ_name}_${this.getCategoryName(key)}.xlsx`,
                                    url: r[key].rawObj.excel_url
                                }));
                        }
                        if (targets.length === 0) {
                            alert("対象のファイルがありません。");
                            this.isZipping = false;
                            return;
                        }
                        const process = async () => {
                            try {
                                const promises = targets.map(async (target) => {
                                    try {
                                        const response = await fetch(target.url);
                                        if (!response.ok) throw new Error("Network error");
                                        const blob = await response.blob();
                                        zip.file(target.name, blob);
                                        count++;
                                    } catch (err) {
                                        console.error(`Failed to load ${target.name}`, err);
                                    }
                                });
                                await Promise.all(promises);
                                if (count === 0) {
                                    alert("ファイルのダウンロードに失敗しました。");
                                } else {
                                    const content = await zip.generateAsync({
                                        type: "blob"
                                    });
                                    saveAs(content, `${this.getCategoryName(key)}_All_Files.zip`);
                                }
                            } catch (e) {
                                console.error(e);
                                alert("ZIP作成中にエラーが発生しました。");
                            } finally {
                                this.isZipping = false;
                            }
                        };
                        process();
                    },

                    /* ニュース投稿 (addNews) */
                    addNews() {
                        if (!this.adminNews.title && !this.adminNews.content) return;
                        const newMsg = {
                            date: this.adminNews.date || new Date().toISOString(),
                            title: this.adminNews.title,
                            content: this.adminNews.content,
                            url: this.adminNews.url || ''
                        };
                        this.newsList.unshift(newMsg);
                        this.saveData(true);
                        this.adminNews = {
                            date: '',
                            title: '',
                            content: '',
                            url: ''
                        };
                    },

                    /* ニュース削除 (deleteNews) */
                    deleteNews(index) {
                        if (!confirm("このニュースを削除しますか？")) return;
                        this.newsList.splice(index, 1);
                        this.saveData(true);
                    },


                    /* 追加登録の新しい枠を追加 (addNewReg) */
                    addNewReg() {
                        this.entry.add_reg.push({
                            id: Date.now(),
                            date: new Date().toLocaleDateString(),
                            count: 0,
                            excel_url: '',
                            payment_id: this.form.univ_id + '02',
                            receipt_url: '',
                            confirmed: false
                        });
                    },

                    /* 不備連絡メール送信 (sendAlertEmail) */
                    sendAlertEmail(rec) {
                        const reason = prompt("不備の内容を入力してください:\n(例: 振込明細が添付されていません、金額が不足しています 等)");
                        if (!reason) return;
                        const payload = {
                            action: 'send_email',
                            to: rec.raw_data.email || prompt("送信先メールアドレスを入力してください"),
                            body: `${rec.univ_name} 様\n\n関東学生バドミントン連盟システムよりご連絡です。\n申請いただいた内容に以下の不備があります。\n\n【不備内容】\n${reason}\n\nシステムより確認・再提出をお願いいたします。`
                        };
                        if (!payload.to) return;
                        fetch(GAS_API_URL, {
                            method: 'POST',
                            body: JSON.stringify(payload)
                        })
                            .then(() => alert("不備連絡メールを送信しました"))
                            .catch(e => alert("送信エラー: " + e.message));
                    },

                    uploadNewsFile(event) {
                        const file = event.target.files[0];
                        if (!file) return;
                        this.isUploadingNews = true;
                        const path = `news/${Date.now()}_${file.name}`;
                        firebase.storage().ref().child(path).put(file).then(s => s.ref.getDownloadURL()).then(url => {
                            this.adminNews.url = url;
                            this.isUploadingNews = false;
                        }).catch(e => {
                            alert("アップロード失敗: " + e.message);
                            this.isUploadingNews = false;
                        });
                    }
                }
            }).mount('#app');
        </script>
</body>

</html>
